<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Configure Windows Server 2022 with Ansible | markkerry.github.io</title><meta name=keywords content="Ansible,Windows Server,CIS"><meta name=description content="In a Windows Server environment which is not domain joined and where group policies are available to configure hosts, it is important to harden the server infrastructure against security vulnerabilities via other methods. In this post I will demonstrate applying the CIS security policies for Windows Server with Ansible. You can find all the configurations for this post on GitHub - ubuntu-config/ansible-win.
Since Ansible cannot be installed on Windows, I am using the same adminbox Ubuntu host which has Ansible installed already from the following posts:"><meta name=author content="Mark kerry"><link rel=canonical href=https://markkerry.github.io/posts/windows-cis-with-ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png><link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.96.0"><script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config",'')</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script><meta property="og:title" content="Configure Windows Server 2022 with Ansible"><meta property="og:description" content="In a Windows Server environment which is not domain joined and where group policies are available to configure hosts, it is important to harden the server infrastructure against security vulnerabilities via other methods. In this post I will demonstrate applying the CIS security policies for Windows Server with Ansible. You can find all the configurations for this post on GitHub - ubuntu-config/ansible-win.
Since Ansible cannot be installed on Windows, I am using the same adminbox Ubuntu host which has Ansible installed already from the following posts:"><meta property="og:type" content="article"><meta property="og:url" content="https://markkerry.github.io/posts/windows-cis-with-ansible/"><meta property="og:image" content="https://markkerry.github.io/images/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-10T09:29:10+00:00"><meta property="article:modified_time" content="2022-04-10T09:29:10+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markkerry.github.io/images/cover.png"><meta name=twitter:title content="Configure Windows Server 2022 with Ansible"><meta name=twitter:description content="In a Windows Server environment which is not domain joined and where group policies are available to configure hosts, it is important to harden the server infrastructure against security vulnerabilities via other methods. In this post I will demonstrate applying the CIS security policies for Windows Server with Ansible. You can find all the configurations for this post on GitHub - ubuntu-config/ansible-win.
Since Ansible cannot be installed on Windows, I am using the same adminbox Ubuntu host which has Ansible installed already from the following posts:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Configure Windows Server 2022 with Ansible","item":"https://markkerry.github.io/posts/windows-cis-with-ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configure Windows Server 2022 with Ansible","name":"Configure Windows Server 2022 with Ansible","description":"In a Windows Server environment which is not domain joined and where group policies are available to configure hosts, it is important to harden the server infrastructure against security vulnerabilities via other methods. In this post I will demonstrate applying the CIS security policies for Windows Server with Ansible. You can find all the configurations for this post on GitHub - ubuntu-config/ansible-win.\nSince Ansible cannot be installed on Windows, I am using the same adminbox Ubuntu host which has Ansible installed already from the following posts:","keywords":["Ansible","Windows Server","CIS"],"articleBody":"In a Windows Server environment which is not domain joined and where group policies are available to configure hosts, it is important to harden the server infrastructure against security vulnerabilities via other methods. In this post I will demonstrate applying the CIS security policies for Windows Server with Ansible. You can find all the configurations for this post on GitHub - ubuntu-config/ansible-win.\nSince Ansible cannot be installed on Windows, I am using the same adminbox Ubuntu host which has Ansible installed already from the following posts:\n markkerry.github.io - Ubuntu Server Lab markkerry.github.io - Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox  I have built another server which has Windows Server 2022 installed which I will configure with Ansible.\n   name OS Memory Disk vCpu     adminbox Ubuntu LTS 20-04 4 GB 20 GB 2   svr1 Windows Server 2022 8 GB 50 GB 2    Setup the Windows Host After the Windows Server OS is installed, we can start by ensuring it is ready to be configured by Ansible. Ansible will interact with the Windows host using WinRM rather than SSH. Ansible provides a script to easily configure WinRM on the host using a Self-Signed SSL certificate.\nDownload and run the script:\n$file = ConfigureRemotingForAnsible.ps1 $uri = \"https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/$file\" Invoke-WebRequest -UserBasicParsing -Uri $uri -OutFile ~\\Desktop\\$file cd ~\\Desktop .\\ConfigureRemotingForAnsible.ps1 I would recommend here setting a static IP on the Windows host so you do not have to update the ip in the Ansible configuration file.\nThat’s all to configure the Windows host. Let’s move on to the adminbox with Ansible installed.\nSetup the Ansible Host In order for Ansible to communicate with the Windows host using WinRM, I need to install the pywinrm Python module. But testresources is a requirement for pywinrm, so I will install both.\npython3 -m pip install --user --ignore-installed tetsresources --no-warn-script-location python3 -m pip install --user --ignore-installed pywinrm --no-warn-script-location Next, I created a new directory to host the Windows Ansible files.\nmkdir ~/ansible-wind \u0026\u0026 cd ~/ansible-win mkdir playbooks Create a new ~/ansible-win/ansible.cfg file which looks as follows:\n# ansible.cfg [defaults] inventory = ./hosts-win host_key_checking = False retry_files_enabled = False Create a new ~/ansible-win/hosts-win file which looks as follows:\n# hosts-win [win] svr1 ansible_host=10.0.2.30 [win:vars] ansible_user=administrator ansible_password=password ansible_port=5986 ansible_connection=winrm ansible_winrm_server_cert_validation=ignore  Note: I would only include a password in this file for testing purposes in a lab environment.\n With the Ansible configuration in place I can now test connectivity to the Windows host.\nansible -m win_ping svr1 As you can see the ping was met with pong. Success.\nRun the CIS-Windows Playbook Using the Ansible Galaxy win_cis collection by jayroad. I have copied them into a playbook.\nThe playbook does require the community.windows collection installed which can be done as follows:\nansible-galaxy collection install community.windows You can find the playbook at GitHub - ubuntu-config/ansible-win\nRun the playbook:\nansible-playbook playbooks/cis-windows.yaml We can now see the logon message has changed and the policies have been applied.\nThis may not be the full CIS baseline but it certainly is a good start and can be expanded upon from here.\n","wordCount":"504","inLanguage":"en","image":"https://markkerry.github.io/images/cover.png","datePublished":"2022-04-10T09:29:10Z","dateModified":"2022-04-10T09:29:10Z","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/windows-cis-with-ansible/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://markkerry.github.io/about/ title=About><span>About</span></a></li><li><a href=https://markkerry.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://markkerry.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>Configure Windows Server 2022 with Ansible</h1><div class=post-meta>April 10, 2022&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Mark kerry</div></header><figure class=entry-cover><img loading=lazy srcset="https://markkerry.github.io/posts/windows-cis-with-ansible/images/cover_hu682d18d9bafb00ff26aa6d84aa3786a2_21259_360x0_resize_box_3.png 360w ,https://markkerry.github.io/posts/windows-cis-with-ansible/images/cover_hu682d18d9bafb00ff26aa6d84aa3786a2_21259_480x0_resize_box_3.png 480w ,https://markkerry.github.io/posts/windows-cis-with-ansible/images/cover.png 701w" sizes="(min-width: 768px) 720px, 100vw" src=https://markkerry.github.io/posts/windows-cis-with-ansible/images/cover.png alt width=701 height=304><p>Configure Windows Server 2022 CIS baseline with Ansible</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#setup-the-windows-host aria-label="Setup the Windows Host">Setup the Windows Host</a></li><li><a href=#setup-the-ansible-host aria-label="Setup the Ansible Host">Setup the Ansible Host</a></li><li><a href=#run-the-cis-windows-playbook aria-label="Run the CIS-Windows Playbook">Run the CIS-Windows Playbook</a></li></ul></div></details></div><div class=post-content><p>In a Windows Server environment which is not domain joined and where group policies are available to configure hosts, it is important to harden the server infrastructure against security vulnerabilities via other methods. In this post I will demonstrate applying the CIS security policies for Windows Server with Ansible. You can find all the configurations for this post on <a href=https://github.com/markkerry/ubuntu-config/tree/main/ansible-win>GitHub - ubuntu-config/ansible-win</a>.</p><p>Since Ansible cannot be installed on Windows, I am using the same adminbox Ubuntu host which has Ansible installed already from the following posts:</p><ul><li><a href=https://markkerry.github.io/posts/2022/02/ubuntu-server-lab/>markkerry.github.io - Ubuntu Server Lab</a></li><li><a href=https://markkerry.github.io/posts/2022/04/ansible-part-1/>markkerry.github.io - Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox</a></li></ul><p>I have built another server which has Windows Server 2022 installed which I will configure with Ansible.</p><table><thead><tr><th>name</th><th>OS</th><th>Memory</th><th>Disk</th><th>vCpu</th></tr></thead><tbody><tr><td>adminbox</td><td>Ubuntu LTS 20-04</td><td>4 GB</td><td>20 GB</td><td>2</td></tr><tr><td>svr1</td><td>Windows Server 2022</td><td>8 GB</td><td>50 GB</td><td>2</td></tr></tbody></table><p><img loading=lazy src=images/virtualBox.png alt=virtualBox></p><h2 id=setup-the-windows-host>Setup the Windows Host<a hidden class=anchor aria-hidden=true href=#setup-the-windows-host>#</a></h2><p>After the Windows Server OS is installed, we can start by ensuring it is ready to be configured by Ansible. Ansible will interact with the Windows host using WinRM rather than SSH. Ansible provides a script to easily configure WinRM on the host using a Self-Signed SSL certificate.</p><p>Download and run the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$file = ConfigureRemotingForAnsible.ps1
</span></span><span style=display:flex><span>$uri = <span style=color:#e6db74>&#34;https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/$file&#34;</span>
</span></span><span style=display:flex><span>Invoke-WebRequest -UserBasicParsing -Uri $uri -OutFile ~\Desktop\$file
</span></span><span style=display:flex><span>cd ~\Desktop
</span></span><span style=display:flex><span>.\ConfigureRemotingForAnsible.ps1
</span></span></code></pre></div><p><img loading=lazy src=images/psScript.png alt=psScript></p><p>I would recommend here setting a static IP on the Windows host so you do not have to update the ip in the Ansible configuration file.</p><p>That&rsquo;s all to configure the Windows host. Let&rsquo;s move on to the adminbox with Ansible installed.</p><h2 id=setup-the-ansible-host>Setup the Ansible Host<a hidden class=anchor aria-hidden=true href=#setup-the-ansible-host>#</a></h2><p>In order for Ansible to communicate with the Windows host using WinRM, I need to install the <code>pywinrm</code> Python module. But <code>testresources</code> is a requirement for <code>pywinrm</code>, so I will install both.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>python3 -m pip install --user --ignore-installed tetsresources --no-warn-script-location
python3 -m pip install --user --ignore-installed pywinrm --no-warn-script-location
</code></pre><p>Next, I created a new directory to host the Windows Ansible files.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>mkdir ~/ansible-wind &amp;&amp; cd ~/ansible-win
mkdir playbooks
</code></pre><p>Create a new <code>~/ansible-win/ansible.cfg</code> file which looks as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal># ansible.cfg

[defaults]
inventory = ./hosts-win
host_key_checking = False
retry_files_enabled = False
</code></pre><p>Create a new <code>~/ansible-win/hosts-win</code> file which looks as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal># hosts-win

[win]
svr1 ansible_host=10.0.2.30

[win:vars]
ansible_user=administrator
ansible_password=password
ansible_port=5986
ansible_connection=winrm
ansible_winrm_server_cert_validation=ignore
</code></pre><blockquote><p>Note: I would only include a password in this file for testing purposes in a lab environment.</p></blockquote><p>With the Ansible configuration in place I can now test connectivity to the Windows host.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible -m win_ping svr1
</code></pre><p>As you can see the <code>ping</code> was met with <code>pong</code>. Success.</p><p><img loading=lazy src=images/winPing.png alt=winPing></p><h2 id=run-the-cis-windows-playbook>Run the CIS-Windows Playbook<a hidden class=anchor aria-hidden=true href=#run-the-cis-windows-playbook>#</a></h2><p>Using the Ansible Galaxy <a href=https://galaxy.ansible.com/jayroad/win_cis>win_cis collection</a> by <a href=https://galaxy.ansible.com/jayroad>jayroad</a>. I have copied them into a playbook.</p><p>The playbook does require the <code>community.windows</code> collection installed which can be done as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-galaxy collection install community.windows
</code></pre><p>You can find the playbook at <a href=https://github.com/markkerry/ubuntu-config/blob/main/ansible-win/playbooks/cis-baseline.yaml>GitHub - ubuntu-config/ansible-win</a></p><p>Run the playbook:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-playbook playbooks/cis-windows.yaml
</code></pre><p><img loading=lazy src=images/runCIS.gif alt=runCIS></p><p>We can now see the logon message has changed and the policies have been applied.</p><p><img loading=lazy src=images/ctrlAltDel.png alt=ctrlAltDel></p><p>This may not be the full CIS baseline but it certainly is a good start and can be expanded upon from here.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://markkerry.github.io/tags/ansible/>Ansible</a></li><li><a href=https://markkerry.github.io/tags/windows-server/>Windows Server</a></li><li><a href=https://markkerry.github.io/tags/cis/>CIS</a></li></ul><nav class=paginav><a class=next href=https://markkerry.github.io/posts/2022/04/ansible-part-1/><span class=title>Next Page »</span><br><span>Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>