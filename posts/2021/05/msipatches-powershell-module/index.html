<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MSIPatches PowerShell Module | markkerry.github.io</title><meta name=keywords content="PowerShell"><meta name=description content="I created a PowerShell module a few years back to safely purge the C:\Windows\Installer directory of any orphaned MSI patches. This directory can often grow very large in size due to applications such as Microsoft Office (MSI not Click-to-Run) being regularly patched. Superseded patches get left behind leaving them in an orphaned state. The MSIPatches module can detect and move the orphaned patches freeing up valuable disk space.
This module requires the MSI module by Heath Stewart, which will be automatically installed when MSIPatches module is installed."><meta name=author content="Mark kerry"><link rel=canonical href=https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png><link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.105.0"><script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script><meta property="og:title" content="MSIPatches PowerShell Module"><meta property="og:description" content="I created a PowerShell module a few years back to safely purge the C:\Windows\Installer directory of any orphaned MSI patches. This directory can often grow very large in size due to applications such as Microsoft Office (MSI not Click-to-Run) being regularly patched. Superseded patches get left behind leaving them in an orphaned state. The MSIPatches module can detect and move the orphaned patches freeing up valuable disk space.
This module requires the MSI module by Heath Stewart, which will be automatically installed when MSIPatches module is installed."><meta property="og:type" content="article"><meta property="og:url" content="https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/"><meta property="og:image" content="https://markkerry.github.io/images/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-28T12:51:14+01:00"><meta property="article:modified_time" content="2021-05-28T12:51:14+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markkerry.github.io/images/cover.png"><meta name=twitter:title content="MSIPatches PowerShell Module"><meta name=twitter:description content="I created a PowerShell module a few years back to safely purge the C:\Windows\Installer directory of any orphaned MSI patches. This directory can often grow very large in size due to applications such as Microsoft Office (MSI not Click-to-Run) being regularly patched. Superseded patches get left behind leaving them in an orphaned state. The MSIPatches module can detect and move the orphaned patches freeing up valuable disk space.
This module requires the MSI module by Heath Stewart, which will be automatically installed when MSIPatches module is installed."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"MSIPatches PowerShell Module","item":"https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MSIPatches PowerShell Module","name":"MSIPatches PowerShell Module","description":"I created a PowerShell module a few years back to safely purge the C:\\Windows\\Installer directory of any orphaned MSI patches. This directory can often grow very large in size due to applications such as Microsoft Office (MSI not Click-to-Run) being regularly patched. Superseded patches get left behind leaving them in an orphaned state. The MSIPatches module can detect and move the orphaned patches freeing up valuable disk space.\nThis module requires the MSI module by Heath Stewart, which will be automatically installed when MSIPatches module is installed.","keywords":["PowerShell"],"articleBody":"I created a PowerShell module a few years back to safely purge the C:\\Windows\\Installer directory of any orphaned MSI patches. This directory can often grow very large in size due to applications such as Microsoft Office (MSI not Click-to-Run) being regularly patched. Superseded patches get left behind leaving them in an orphaned state. The MSIPatches module can detect and move the orphaned patches freeing up valuable disk space.\nThis module requires the MSI module by Heath Stewart, which will be automatically installed when MSIPatches module is installed.\nI’m please to see the module has been downloaded over 6,000 times from the PowerShell Gallery. You can find the module at the project site GitHub repo and in the PowerShell Gallery.\nMSIPatches Functions The following cmdlets/advanced functions are available in the MSIPatches module.\nGet-MsiPatch.ps1 Lists all msp files in $env:SystemRoot\\Installer\\ Calculates their total size Gets installed patches and size Gets orphaned patches and size Get-OrphanedPatch.ps1 Lists all orphaned patches in $env:SystemRoot\\Installer\\ Outputs the objects as [System.IO.FileInfo] which can be piped to the next functions. Move-OrphanedPatch.ps1 Moves all orphaned patches in $env:SystemRoot\\Installer\\ to a specified location. Restore-OrphanedPatch.ps1 Restores all previously backed up orphaned patches to $env:SystemRoot\\Installer\\ Installation You can install the module from the PowerShell gallery\nInstall-Module MSIPatches # List the commands in the MSIPatches module Get-Command -Module MSIPatches CommandType Name Version Source ----------- ---- ------- ------ Function Get-MsiPatch 1.0.21 MSIPatches Function Get-OrphanedPatch 1.0.21 MSIPatches Function Move-OrphanedPatch 1.0.21 MSIPatches Function Restore-OrphanedPatch 1.0.21 MSIPatches # Get-Help Get-Help about_MSIPatches Get-Help Get-MsiPatches How to Use MSIPatches Since we are modifying the contents of the $env:SystemRoot\\Installer\\ directory, we will have to run an elevated PowerShell session.\nGet a count of all MSI patches with Get-MsiPatch. Notice in the example below, there 129 orphaned patches discovered, totalling 8.81 GB in size.\nThe Get-OrphanedPatch command returns [System.IO.FileInfo] objects, listing every orphaned patch discovered.\nPass the [System.IO.FileInfo] objects through the pipeline to Move-OrphanedPatch. The following examples shows C:\\Backup as the location. This obviously isn’t a good idea since we are trying to free up space on the C:\\ drive.\nGet-OrphanedPatch | Move-OrphanedPatch -Destination C:\\Backup Press y to create the directory if it doesn’t exist.\nAfter you move the orphaned patches, you can run the Get-MsiPatch command again to see the results. There are now zero orphaned patches and the installed ones are still intact.\nYou can restore previously backed up msp files using the Restore-OrphanedPatch command.\nRestore-OrphanedPatch -BackupLocation If the directory doesn’t exist/inaccessible or doesn’t contain any msp files, the following will display\nNote: you can pass the [System.IO.FileInfo] objects through the pipeline to Remove-Item to permanently delete the msp files. Recommend you pipe to Move-OrphanedPatch instead.\nGet-OrphanedPatch | Remove-Item -Force ","wordCount":"442","inLanguage":"en","image":"https://markkerry.github.io/images/cover.png","datePublished":"2021-05-28T12:51:14+01:00","dateModified":"2021-05-28T12:51:14+01:00","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://markkerry.github.io/about/ title=About><span>About</span></a></li><li><a href=https://markkerry.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://markkerry.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>MSIPatches PowerShell Module</h1><div class=post-meta>May 28, 2021&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Mark kerry</div></header><figure class=entry-cover><img loading=lazy srcset="https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/images/cover_hua9b48e89c7bab492b4a796924088d28e_25226_360x0_resize_box_3.png 360w ,https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/images/cover_hua9b48e89c7bab492b4a796924088d28e_25226_480x0_resize_box_3.png 480w ,https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/images/cover.png 657w" sizes="(min-width: 768px) 720px, 100vw" src=https://markkerry.github.io/posts/2021/05/msipatches-powershell-module/images/cover.png alt width=657 height=286><p>Use the MSIPatches PowerShell module to free space on your C: drive</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#msipatches-functions aria-label="MSIPatches Functions">MSIPatches Functions</a><ul><li><a href=#get-msipatchps1 aria-label=Get-MsiPatch.ps1>Get-MsiPatch.ps1</a></li><li><a href=#get-orphanedpatchps1 aria-label=Get-OrphanedPatch.ps1>Get-OrphanedPatch.ps1</a></li><li><a href=#move-orphanedpatchps1 aria-label=Move-OrphanedPatch.ps1>Move-OrphanedPatch.ps1</a></li><li><a href=#restore-orphanedpatchps1 aria-label=Restore-OrphanedPatch.ps1>Restore-OrphanedPatch.ps1</a></li></ul></li><li><a href=#installation aria-label=Installation>Installation</a></li><li><a href=#how-to-use-msipatches aria-label="How to Use MSIPatches">How to Use MSIPatches</a></li></ul></div></details></div><div class=post-content><p>I created a PowerShell module a few years back to safely purge the <code>C:\Windows\Installer</code> directory of any orphaned MSI patches. This directory can often grow very large in size due to applications such as Microsoft Office (MSI not Click-to-Run) being regularly patched. Superseded patches get left behind leaving them in an orphaned state. The MSIPatches module can detect and move the orphaned patches freeing up valuable disk space.</p><p>This module requires the <a href=https://github.com/heaths/psmsi>MSI</a> module by <a href=https://github.com/heaths>Heath Stewart</a>, which will be automatically installed when MSIPatches module is installed.</p><p>I&rsquo;m please to see the module has been downloaded over 6,000 times from the PowerShell Gallery. You can find the module at the project site <a href=https://github.com/markkerry/MSIPatches>GitHub</a> repo and in the <a href=https://www.powershellgallery.com/packages/MSIPatches/1.0.20>PowerShell Gallery</a>.</p><h2 id=msipatches-functions>MSIPatches Functions<a hidden class=anchor aria-hidden=true href=#msipatches-functions>#</a></h2><p>The following cmdlets/advanced functions are available in the MSIPatches module.</p><h3 id=get-msipatchps1>Get-MsiPatch.ps1<a hidden class=anchor aria-hidden=true href=#get-msipatchps1>#</a></h3><ul><li>Lists all msp files in <code>$env:SystemRoot\Installer\</code></li><li>Calculates their total size</li><li>Gets installed patches and size</li><li>Gets orphaned patches and size</li></ul><h3 id=get-orphanedpatchps1>Get-OrphanedPatch.ps1<a hidden class=anchor aria-hidden=true href=#get-orphanedpatchps1>#</a></h3><ul><li>Lists all orphaned patches in <code>$env:SystemRoot\Installer\</code></li><li>Outputs the objects as <code>[System.IO.FileInfo]</code> which can be piped to the next functions.</li></ul><h3 id=move-orphanedpatchps1>Move-OrphanedPatch.ps1<a hidden class=anchor aria-hidden=true href=#move-orphanedpatchps1>#</a></h3><ul><li>Moves all orphaned patches in <code>$env:SystemRoot\Installer\</code> to a specified location.</li></ul><h3 id=restore-orphanedpatchps1>Restore-OrphanedPatch.ps1<a hidden class=anchor aria-hidden=true href=#restore-orphanedpatchps1>#</a></h3><ul><li>Restores all previously backed up orphaned patches to <code>$env:SystemRoot\Installer\</code></li></ul><h2 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h2><p>You can install the module from the PowerShell gallery</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Module MSIPatches
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List the commands in the MSIPatches module</span>
</span></span><span style=display:flex><span>Get-Command -Module MSIPatches
</span></span></code></pre></div><pre tabindex=0><code class=language-terminal data-lang=terminal>CommandType  Name                   Version  Source
-----------  ----                   -------  ------
Function     Get-MsiPatch           1.0.21   MSIPatches
Function     Get-OrphanedPatch      1.0.21   MSIPatches
Function     Move-OrphanedPatch     1.0.21   MSIPatches
Function     Restore-OrphanedPatch  1.0.21   MSIPatches
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Get-Help</span>
</span></span><span style=display:flex><span>Get-Help about_MSIPatches
</span></span><span style=display:flex><span>Get-Help Get-MsiPatches
</span></span></code></pre></div><h2 id=how-to-use-msipatches>How to Use MSIPatches<a hidden class=anchor aria-hidden=true href=#how-to-use-msipatches>#</a></h2><p>Since we are modifying the contents of the <code>$env:SystemRoot\Installer\</code> directory, we will have to run an elevated PowerShell session.</p><p>Get a count of all MSI patches with <code>Get-MsiPatch</code>. Notice in the example below, there 129 orphaned patches discovered, totalling 8.81 GB in size.</p><p><img loading=lazy src=images/Get-MsiPatch_01.png alt=Get-MsiPatch></p><p>The <code>Get-OrphanedPatch</code> command returns <code>[System.IO.FileInfo]</code> objects, listing every orphaned patch discovered.</p><p><img loading=lazy src=images/Get-OrphanedPatch_01.png alt=Get-OrphanedPatch></p><p>Pass the <code>[System.IO.FileInfo]</code> objects through the pipeline to <code>Move-OrphanedPatch</code>. The following examples shows <code>C:\Backup</code> as the location. This obviously isn&rsquo;t a good idea since we are trying to free up space on the C:\ drive.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-OrphanedPatch | Move-OrphanedPatch -Destination C:\Backup
</span></span></code></pre></div><p><img loading=lazy src=images/Move-OrphanedPatch_01.png alt=Move-OrphanedPatch></p><p>Press <code>y</code> to create the directory if it doesn&rsquo;t exist.</p><p><img loading=lazy src=images/Move-OrphanedPatch_02.png alt=Move-OrphanedPatch></p><p>After you move the orphaned patches, you can run the <code>Get-MsiPatch</code> command again to see the results. There are now zero orphaned patches and the installed ones are still intact.</p><p><img loading=lazy src=images/Move-OrphanedPatch_03.png alt=Move-OrphanedPatch></p><p>You can restore previously backed up msp files using the <code>Restore-OrphanedPatch</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Restore-OrphanedPatch -BackupLocation &lt;String&gt;
</span></span></code></pre></div><p><img loading=lazy src=images/Restore-OrphanedPatch_01.png alt=Restore-OrphanedPatch></p><p>If the directory doesn&rsquo;t exist/inaccessible or doesn&rsquo;t contain any msp files, the following will display</p><p><img loading=lazy src=images/Restore-OrphanedPatch_02.png alt=Restore-OrphanedPatch><br><img loading=lazy src=images/Restore-OrphanedPatch_03.png alt=Restore-OrphanedPatch></p><blockquote><p>Note: you can pass the [System.IO.FileInfo] objects through the pipeline to <code>Remove-Item</code> to permanently delete the msp files. Recommend you pipe to <code>Move-OrphanedPatch</code> instead.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-OrphanedPatch | Remove-Item -Force
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://markkerry.github.io/tags/powershell/>PowerShell</a></li></ul><nav class=paginav><a class=prev href=https://markkerry.github.io/posts/2021/06/azure-arm-templates-part-1-development/><span class=title>« Prev Page</span><br><span>Azure ARM Templates - Part 1: Development</span></a>
<a class=next href=https://markkerry.github.io/posts/2021/05/centos8-setup/><span class=title>Next Page »</span><br><span>Installing & Configuring CentOS 8 Minimal Install</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>