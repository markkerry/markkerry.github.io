<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage | markkerry.github.io</title><meta name=keywords content="Azure,Azure Function,PowerShell,Autopilot,Serverless,Microsoft Graph"><meta name=description content="Thanks to Powers-Hell (Ben) for the handy Get-AuthHeader and Invoke-GraphCall PowerShell functions.
Introduction There may be a scenario where you need all of your Intune managed, Autopilot registered devices setup on a new tenant. But there are a few challenges you will face:
 An OEM may have uploaded every device&rsquo;s hardware hash to Autopilot, so you do not have them to upload to the new tenant. An Autopilot device cannot be deleted from the registration service while it&rsquo;s a &ldquo;managed device&rdquo; (enrolled in Intune)."><meta name=author content="Mark kerry"><link rel=canonical href=https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png><link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.98.0"><script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config",'')</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script><meta property="og:title" content="Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage"><meta property="og:description" content="Thanks to Powers-Hell (Ben) for the handy Get-AuthHeader and Invoke-GraphCall PowerShell functions.
Introduction There may be a scenario where you need all of your Intune managed, Autopilot registered devices setup on a new tenant. But there are a few challenges you will face:
 An OEM may have uploaded every device&rsquo;s hardware hash to Autopilot, so you do not have them to upload to the new tenant. An Autopilot device cannot be deleted from the registration service while it&rsquo;s a &ldquo;managed device&rdquo; (enrolled in Intune)."><meta property="og:type" content="article"><meta property="og:url" content="https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/"><meta property="og:image" content="https://markkerry.github.io/images/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-26T10:31:24+01:00"><meta property="article:modified_time" content="2021-09-26T10:31:24+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markkerry.github.io/images/cover.png"><meta name=twitter:title content="Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage"><meta name=twitter:description content="Thanks to Powers-Hell (Ben) for the handy Get-AuthHeader and Invoke-GraphCall PowerShell functions.
Introduction There may be a scenario where you need all of your Intune managed, Autopilot registered devices setup on a new tenant. But there are a few challenges you will face:
 An OEM may have uploaded every device&rsquo;s hardware hash to Autopilot, so you do not have them to upload to the new tenant. An Autopilot device cannot be deleted from the registration service while it&rsquo;s a &ldquo;managed device&rdquo; (enrolled in Intune)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage","item":"https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage","name":"Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage","description":"Thanks to Powers-Hell (Ben) for the handy Get-AuthHeader and Invoke-GraphCall PowerShell functions.\nIntroduction There may be a scenario where you need all of your Intune managed, Autopilot registered devices setup on a new tenant. But there are a few challenges you will face:\n An OEM may have uploaded every device\u0026rsquo;s hardware hash to Autopilot, so you do not have them to upload to the new tenant. An Autopilot device cannot be deleted from the registration service while it\u0026rsquo;s a \u0026ldquo;managed device\u0026rdquo; (enrolled in Intune).","keywords":["Azure","Azure Function","PowerShell","Autopilot","Serverless","Microsoft Graph"],"articleBody":"Thanks to Powers-Hell (Ben) for the handy Get-AuthHeader and Invoke-GraphCall PowerShell functions.\nIntroduction There may be a scenario where you need all of your Intune managed, Autopilot registered devices setup on a new tenant. But there are a few challenges you will face:\n An OEM may have uploaded every device’s hardware hash to Autopilot, so you do not have them to upload to the new tenant. An Autopilot device cannot be deleted from the registration service while it’s a “managed device” (enrolled in Intune). The device will need to be reset and Autopilot provisioned in the new tenant, so setting a machine to wipe, then deleting from one tenant and registering with another, is a manual task which you may fail to complete during the device reset.  This post will provide a high-level overview of the automated process to go from one tenant to another. This can be achieved by sending the hardware hash csv file to an Azure Storage Account, using an Azure Function to de-register from one tenant, another Function to register with another tenant, all while the device is resetting. It assumes you have a good fundamental understanding of Azure Storage, Azure Functions and performing MS Graph queries.\nAdmittedly, this is a slightly over engineered solution, which quite honestly I don’t expect anybody to follow. But it does work and it’s fun to see what we can achieve using the Azure cloud and MS Graph. All of the code from this post can be found here on GitHub.\nA future post will walk through a lower-level, single script method.\nDesign Overview See the drawing below for a full overview of the end-to-end process. In the example below, “Tenant A” is the old, source tenant and “Tenant B” is the new, destination tenant.\n The end user starts an app from the Company Portal which is a PowerShell script. It exports the hardware hash as it’s “serialnumber”.csv and posts it to an Azure Storage Account using azcopy.exe and a shared access signature (SAS). Then the script posts the device’s hostname to Azure Function 1. Azure Function 1 authenticates to graph using an App Registration in Tenant A, deletes the Intune managed device, Autopilot registration, and syncs the Autopilot registration service. Once complete, Function 1 posts the device’s serial number in the body of “serialnumber.csv” to Azure Function 2. Azure Function 2 then downloads the “serialnumber.csv” from the Storage Account using a different SAS. Azure Function 2 imports the csv information, authenticates to graph using an App Registration in Tenant B and performs graph queries to register the device and sync the Autopilot registration service. Function 1 sends back the HTTP response to the client. The client completes the script by resetting the device and Autopilot provisioning in Tenant B.  Resource Requirements In this section I will go over the requirements of the individual requirements and recommend they get provisioned in this order.\nTenant B - Storage Account The Storage Account can sit in either tenant, but as the devices and their hash will belong to Tenant B going forward, makes sense to provision it there. Create as follows:\n Performance/Access tier : Standard/Hot Replication : Locally-redundant storage (LRS) Account Kind : StorageV2 (general purpose v2)  Tenant A - SAS Key for Function 2 Function 2, which will be created last requires a SAS to be able to download the csv file from the Storage Account. Create one by browsing to the Azure Portal:\n Select the storage account Shared access signature Allowed services : Blob Allowed resource types : Object Allowed permissions : Read Set an expiry which works for you Click Generate SAS and connection string Copy the Blob service SAS URL for the function’s $blobUri variable  Tenant A - SAS Key for Client Script The client script will need to include as SAS key to upload the csv to the Storage Account. Create one by browsing to the Azure Portal:\n Select the storage account Shared access signature Allowed services : Blob Allowed resource types : Object Allowed permissions : Write Set an expiry which works for you Click Generate SAS and connection string Copy the Blob service SAS URL for the client script’s $blobUri variable (Next step)  Tenant A - Client Script  WARNING - The client script includes code which will wipe the end user device\n You can find the client script on GitHub. This will need to wrapped as a win32 app and made available for the end user. After the script is invoked, posted it’s hardware hash to the storage account, and triggered the Azure Function, it will reset it’s OS.\nAfter creating the Storage Account, the variable $blobUri will have to be updated with the Blob service SAS URL. And after creating Azure Function 1, the $uri variable will need to be updated with the function URL.\nTenant A - App Registration for Function 1 An Azure AD App Registration is required in order to authenticate and perform Graph queries against Tenant A. In the Azure Portal select Azure Active Directory / App registrations / New registration. Then set the following:\n Name : Name the app registration Supported account types : Accounts in this organizational directory only Click register  To configure the permissions of the app registration, select API Permissions:\n Add permission Microsoft Graph Application permissions Select DeviceManagementManagedDevices.ReadWrite.All Select DeviceManagementServiceConfig.ReadWrite.All Then Grant admin consent for “tenant name”  Now create a client secret for the app registration. Select Certificates and secrets:\n New client secret Description : Name it yourself Expires : Set a time which works for you Click Add Copy the Value somewhere safe to be used for Azure Function 1 (next step) Copy the Application (client) ID to be used for Azure Function 1 (next step)  Tenant A - Azure Function 1 The code for function 1 and can be found here on GitHub. Create the Azure Function in tenant A with the following:\n Name : Name the function Publish : Code Runtime stack : PowerShell Core Version : 7.0 Storage account : Create new Operating System : Windows Plan type : Consumption (Serverless) Application Insights : Up to you  Then create new function app with the code from GitHub. Once the function has been created, open it and select Configuration. Under Application settings create three new application settings as follows:\n   Name Value     CLIENT_ID The client ID of the app registration you just created   CLIENT_SECRET The secret of the app registration you just created   TENANT_ID The name of Tenant A. E.g. contosoa.com    Tenant B - App Registration for Function 2 An Azure AD App Registration is required in order to authenticate and perform Graph queries against Tenant B. In the Azure Portal select Azure Active Directory / App registrations / New registration. Then set the following:\n Name : Name the app registration Supported account types : Accounts in this organizational directory only Click register  To configure the permissions of the app registration, select API Permissions:\n Add permission Microsoft Graph Application permissions Select DeviceManagementServiceConfig.ReadWrite.All Then Grant admin consent for “tenant name”  Now create a client secret for the app registration. Select Certificates and secrets:\n New client secret Description : Name it yourself Expires : Set a time which works for you Click Add Copy the Value somewhere safe to be used for Azure Function 2 (next step) Copy the Application (client) ID to be used for Azure Function 2 (next step)  Tenant B - Azure Function 2 The code for function 2 and can be found here on GitHub. Create the Azure Function in tenant B with the following:\n Name : Name the function Publish : Code Runtime stack : PowerShell Core Version : 7.0 Storage account : Create new Operating System : Windows Plan type : Consumption (Serverless) Application Insights : Up to you  Then create new function app with the code from GitHub. Once the function has been created, open it and select Configuration. Under Application settings create three new application settings as follows:\n   Name Value     CLIENT_ID The client ID of the app registration you just created   CLIENT_SECRET The secret of the app registration you just created   TENANT_ID The name of Tenant B. E.g. contosob.com    Conclusion Hopefully this gives you a rough idea of what can be achieved using Azure Functions and Microsoft Graph. The functions do not have to be http triggered. They could both be triggered from the csv storage blob. I plan to create a more in-depth post of the same goal but a far simpler process.\n","wordCount":"1406","inLanguage":"en","image":"https://markkerry.github.io/images/cover.png","datePublished":"2021-09-26T10:31:24+01:00","dateModified":"2021-09-26T10:31:24+01:00","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://markkerry.github.io/about/ title=About><span>About</span></a></li><li><a href=https://markkerry.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://markkerry.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>Automated Autopilot Tenant Move Part 1: Using Graph, Azure Functions and Azure Storage</h1><div class=post-meta>September 26, 2021&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Mark kerry</div></header><figure class=entry-cover><img loading=lazy srcset="https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/images/cover_hu8b85997703f7fd1e8bd9dab3c1ae2e27_25957_360x0_resize_box_3.png 360w ,https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/images/cover_hu8b85997703f7fd1e8bd9dab3c1ae2e27_25957_480x0_resize_box_3.png 480w ,https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/images/cover.png 712w" sizes="(min-width: 768px) 720px, 100vw" src=https://markkerry.github.io/posts/2021/09/automated-autopilot-tenant-move-part1/images/cover.png alt width=712 height=146><p>Automated process to wipe, then de-register an Autopilot device from one tenant and register to another</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#design-overview aria-label="Design Overview">Design Overview</a></li><li><a href=#resource-requirements aria-label="Resource Requirements">Resource Requirements</a><ul><li><a href=#tenant-b---storage-account aria-label="Tenant B - Storage Account">Tenant B - Storage Account</a></li><li><a href=#tenant-a---sas-key-for-function-2 aria-label="Tenant A - SAS Key for Function 2">Tenant A - SAS Key for Function 2</a></li><li><a href=#tenant-a---sas-key-for-client-script aria-label="Tenant A - SAS Key for Client Script">Tenant A - SAS Key for Client Script</a></li><li><a href=#tenant-a---client-script aria-label="Tenant A - Client Script">Tenant A - Client Script</a></li><li><a href=#tenant-a---app-registration-for-function-1 aria-label="Tenant A - App Registration for Function 1">Tenant A - App Registration for Function 1</a></li><li><a href=#tenant-a---azure-function-1 aria-label="Tenant A - Azure Function 1">Tenant A - Azure Function 1</a></li><li><a href=#tenant-b---app-registration-for-function-2 aria-label="Tenant B - App Registration for Function 2">Tenant B - App Registration for Function 2</a></li><li><a href=#tenant-b---azure-function-2 aria-label="Tenant B - Azure Function 2">Tenant B - Azure Function 2</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>Thanks to <a href=https://powers-hell.com/2021/06/16/create-advanced-dynamic-groups-with-powershell-azure-functions/>Powers-Hell (Ben)</a> for the handy <code>Get-AuthHeader</code> and <code>Invoke-GraphCall</code> PowerShell functions.</p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>There may be a scenario where you need all of your Intune managed, Autopilot registered devices setup on a new tenant. But there are a few challenges you will face:</p><ul><li>An OEM may have uploaded every device&rsquo;s hardware hash to Autopilot, so you do not have them to upload to the new tenant.</li><li>An Autopilot device cannot be deleted from the registration service while it&rsquo;s a &ldquo;managed device&rdquo; (enrolled in Intune).</li><li>The device will need to be reset and Autopilot provisioned in the new tenant, so setting a machine to wipe, then deleting from one tenant and registering with another, is a manual task which you may fail to complete during the device reset.</li></ul><p>This post will provide a high-level overview of the automated process to go from one tenant to another. This can be achieved by sending the hardware hash csv file to an Azure Storage Account, using an Azure Function to de-register from one tenant, another Function to register with another tenant, all while the device is resetting. It assumes you have a good fundamental understanding of Azure Storage, Azure Functions and performing MS Graph queries.</p><p>Admittedly, this is a slightly over engineered solution, which quite honestly I don&rsquo;t expect anybody to follow. But it does work and it&rsquo;s fun to see what we can achieve using the Azure cloud and MS Graph. All of the code from this post can be found <a href=https://github.com/markkerry/automated-autopilot-tenant-move>here on GitHub</a>.</p><p>A future post will walk through a lower-level, single script method.</p><h2 id=design-overview>Design Overview<a hidden class=anchor aria-hidden=true href=#design-overview>#</a></h2><p>See the drawing below for a full overview of the end-to-end process. In the example below, &ldquo;Tenant A&rdquo; is the old, source tenant and &ldquo;Tenant B&rdquo; is the new, destination tenant.</p><p><img loading=lazy src=images/AutopilotTenantMove.png alt=AutopilotTenantMove></p><ol><li>The end user starts an app from the Company Portal which is a PowerShell script. It exports the hardware hash as it&rsquo;s &ldquo;serialnumber&rdquo;.csv and posts it to an Azure Storage Account using <code>azcopy.exe</code> and a shared access signature (SAS).</li><li>Then the script posts the device&rsquo;s hostname to Azure Function 1.</li><li>Azure Function 1 authenticates to graph using an App Registration in Tenant A, deletes the Intune managed device, Autopilot registration, and syncs the Autopilot registration service.</li><li>Once complete, Function 1 posts the device&rsquo;s serial number in the body of &ldquo;serialnumber.csv&rdquo; to Azure Function 2.</li><li>Azure Function 2 then downloads the &ldquo;serialnumber.csv&rdquo; from the Storage Account using a different SAS.</li><li>Azure Function 2 imports the csv information, authenticates to graph using an App Registration in Tenant B and performs graph queries to register the device and sync the Autopilot registration service.</li><li>Function 1 sends back the HTTP response to the client.</li><li>The client completes the script by resetting the device and Autopilot provisioning in Tenant B.</li></ol><h2 id=resource-requirements>Resource Requirements<a hidden class=anchor aria-hidden=true href=#resource-requirements>#</a></h2><p>In this section I will go over the requirements of the individual requirements and recommend they get provisioned in this order.</p><h3 id=tenant-b---storage-account>Tenant B - Storage Account<a hidden class=anchor aria-hidden=true href=#tenant-b---storage-account>#</a></h3><p>The Storage Account can sit in either tenant, but as the devices and their hash will belong to Tenant B going forward, makes sense to provision it there. Create as follows:</p><ul><li><strong>Performance/Access tier</strong> : Standard/Hot</li><li><strong>Replication</strong> : Locally-redundant storage (LRS)</li><li><strong>Account Kind</strong> : StorageV2 (general purpose v2)</li></ul><h3 id=tenant-a---sas-key-for-function-2>Tenant A - SAS Key for Function 2<a hidden class=anchor aria-hidden=true href=#tenant-a---sas-key-for-function-2>#</a></h3><p>Function 2, which will be created last requires a SAS to be able to download the csv file from the Storage Account. Create one by browsing to the Azure Portal:</p><ul><li>Select the storage account</li><li>Shared access signature</li><li><strong>Allowed services</strong> : Blob</li><li><strong>Allowed resource types</strong> : Object</li><li><strong>Allowed permissions</strong> : Read</li><li>Set an expiry which works for you</li><li>Click <strong>Generate SAS and connection string</strong></li><li>Copy the <strong>Blob service SAS URL</strong> for the function&rsquo;s <code>$blobUri</code> variable</li></ul><h3 id=tenant-a---sas-key-for-client-script>Tenant A - SAS Key for Client Script<a hidden class=anchor aria-hidden=true href=#tenant-a---sas-key-for-client-script>#</a></h3><p>The client script will need to include as SAS key to upload the csv to the Storage Account. Create one by browsing to the Azure Portal:</p><ul><li>Select the storage account</li><li>Shared access signature</li><li><strong>Allowed services</strong> : Blob</li><li><strong>Allowed resource types</strong> : Object</li><li><strong>Allowed permissions</strong> : Write</li><li>Set an expiry which works for you</li><li>Click <strong>Generate SAS and connection string</strong></li><li>Copy the <strong>Blob service SAS URL</strong> for the client script&rsquo;s <code>$blobUri</code> variable (Next step)</li></ul><h3 id=tenant-a---client-script>Tenant A - Client Script<a hidden class=anchor aria-hidden=true href=#tenant-a---client-script>#</a></h3><blockquote><p><strong>WARNING - The client script includes code which will wipe the end user device</strong></p></blockquote><p>You can find the client script on <a href=https://github.com/markkerry/automated-autopilot-tenant-move/tree/main/client-script>GitHub</a>. This will need to wrapped as a win32 app and made available for the end user. After the script is invoked, posted it&rsquo;s hardware hash to the storage account, and triggered the Azure Function, it will reset it&rsquo;s OS.</p><p>After creating the Storage Account, the variable <code>$blobUri</code> will have to be updated with the <strong>Blob service SAS URL</strong>. And after creating Azure Function 1, the <code>$uri</code> variable will need to be updated with the function URL.</p><h3 id=tenant-a---app-registration-for-function-1>Tenant A - App Registration for Function 1<a hidden class=anchor aria-hidden=true href=#tenant-a---app-registration-for-function-1>#</a></h3><p>An Azure AD App Registration is required in order to authenticate and perform Graph queries against Tenant A. In the Azure Portal select <strong>Azure Active Directory / App registrations / New registration</strong>. Then set the following:</p><ul><li><strong>Name</strong> : Name the app registration</li><li><strong>Supported account types</strong> : Accounts in this organizational directory only</li><li>Click register</li></ul><p>To configure the permissions of the app registration, select <strong>API Permissions</strong>:</p><ul><li>Add permission</li><li>Microsoft Graph</li><li>Application permissions</li><li>Select <strong>DeviceManagementManagedDevices.ReadWrite.All</strong></li><li>Select <strong>DeviceManagementServiceConfig.ReadWrite.All</strong></li><li>Then <strong>Grant admin consent for &ldquo;tenant name&rdquo;</strong></li></ul><p>Now create a client secret for the app registration. Select <strong>Certificates and secrets</strong>:</p><ul><li>New client secret</li><li><strong>Description</strong> : Name it yourself</li><li><strong>Expires</strong> : Set a time which works for you</li><li>Click <strong>Add</strong></li><li>Copy the <strong>Value</strong> somewhere safe to be used for Azure Function 1 (next step)</li><li>Copy the <strong>Application (client) ID</strong> to be used for Azure Function 1 (next step)</li></ul><h3 id=tenant-a---azure-function-1>Tenant A - Azure Function 1<a hidden class=anchor aria-hidden=true href=#tenant-a---azure-function-1>#</a></h3><p>The code for function 1 and can be found here on <a href=https://github.com/markkerry/automated-autopilot-tenant-move/tree/main/func1-delete-from-tenant/src>GitHub</a>. Create the Azure Function in tenant A with the following:</p><ul><li><strong>Name</strong> : Name the function</li><li><strong>Publish</strong> : Code</li><li><strong>Runtime stack</strong> : PowerShell Core</li><li><strong>Version</strong> : 7.0</li><li><strong>Storage account</strong> : Create new</li><li><strong>Operating System</strong> : Windows</li><li><strong>Plan type</strong> : Consumption (Serverless)</li><li><strong>Application Insights</strong> : Up to you</li></ul><p>Then create new function app with the code from <a href=https://github.com/markkerry/automated-autopilot-tenant-move/tree/main/func1-delete-from-tenant/src>GitHub</a>. Once the function has been created, open it and select <strong>Configuration</strong>. Under <strong>Application settings</strong> create three new application settings as follows:</p><table><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody><tr><td>CLIENT_ID</td><td>The client ID of the app registration you just created</td></tr><tr><td>CLIENT_SECRET</td><td>The secret of the app registration you just created</td></tr><tr><td>TENANT_ID</td><td>The name of Tenant A. E.g. contosoa.com</td></tr></tbody></table><h3 id=tenant-b---app-registration-for-function-2>Tenant B - App Registration for Function 2<a hidden class=anchor aria-hidden=true href=#tenant-b---app-registration-for-function-2>#</a></h3><p>An Azure AD App Registration is required in order to authenticate and perform Graph queries against Tenant B. In the Azure Portal select <strong>Azure Active Directory / App registrations / New registration</strong>. Then set the following:</p><ul><li><strong>Name</strong> : Name the app registration</li><li><strong>Supported account types</strong> : Accounts in this organizational directory only</li><li>Click register</li></ul><p>To configure the permissions of the app registration, select <strong>API Permissions</strong>:</p><ul><li>Add permission</li><li>Microsoft Graph</li><li>Application permissions</li><li>Select <strong>DeviceManagementServiceConfig.ReadWrite.All</strong></li><li>Then <strong>Grant admin consent for &ldquo;tenant name&rdquo;</strong></li></ul><p>Now create a client secret for the app registration. Select <strong>Certificates and secrets</strong>:</p><ul><li>New client secret</li><li><strong>Description</strong> : Name it yourself</li><li><strong>Expires</strong> : Set a time which works for you</li><li>Click <strong>Add</strong></li><li>Copy the <strong>Value</strong> somewhere safe to be used for Azure Function 2 (next step)</li><li>Copy the <strong>Application (client) ID</strong> to be used for Azure Function 2 (next step)</li></ul><h3 id=tenant-b---azure-function-2>Tenant B - Azure Function 2<a hidden class=anchor aria-hidden=true href=#tenant-b---azure-function-2>#</a></h3><p>The code for function 2 and can be found here on <a href=https://github.com/markkerry/automated-autopilot-tenant-move/tree/main/func2-register-to-tenant/src>GitHub</a>. Create the Azure Function in tenant B with the following:</p><ul><li><strong>Name</strong> : Name the function</li><li><strong>Publish</strong> : Code</li><li><strong>Runtime stack</strong> : PowerShell Core</li><li><strong>Version</strong> : 7.0</li><li><strong>Storage account</strong> : Create new</li><li><strong>Operating System</strong> : Windows</li><li><strong>Plan type</strong> : Consumption (Serverless)</li><li><strong>Application Insights</strong> : Up to you</li></ul><p>Then create new function app with the code from <a href=https://github.com/markkerry/automated-autopilot-tenant-move/tree/main/func2-register-to-tenant/src>GitHub</a>. Once the function has been created, open it and select <strong>Configuration</strong>. Under <strong>Application settings</strong> create three new application settings as follows:</p><table><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody><tr><td>CLIENT_ID</td><td>The client ID of the app registration you just created</td></tr><tr><td>CLIENT_SECRET</td><td>The secret of the app registration you just created</td></tr><tr><td>TENANT_ID</td><td>The name of Tenant B. E.g. contosob.com</td></tr></tbody></table><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Hopefully this gives you a rough idea of what can be achieved using Azure Functions and Microsoft Graph. The functions do not have to be http triggered. They could both be triggered from the csv storage blob. I plan to create a more in-depth post of the same goal but a far simpler process.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://markkerry.github.io/tags/azure/>Azure</a></li><li><a href=https://markkerry.github.io/tags/azure-function/>Azure Function</a></li><li><a href=https://markkerry.github.io/tags/powershell/>PowerShell</a></li><li><a href=https://markkerry.github.io/tags/autopilot/>Autopilot</a></li><li><a href=https://markkerry.github.io/tags/serverless/>Serverless</a></li><li><a href=https://markkerry.github.io/tags/microsoft-graph/>Microsoft Graph</a></li></ul><nav class=paginav><a class=prev href=https://markkerry.github.io/posts/2021/10/automated-autopilot-tenant-move-part2/><span class=title>« Prev Page</span><br><span>Automated Autopilot Tenant Move Part 2: Using PowerShell and Graph</span></a>
<a class=next href=https://markkerry.github.io/posts/2021/08/azure-functions-console-sandbox/><span class=title>Next Page »</span><br><span>Quick How-to: Using the Azure Functions Console Sandbox</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>