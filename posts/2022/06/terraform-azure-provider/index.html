<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform Azure Provider | markkerry.github.io</title><meta name=keywords content="Terraform,Azure,IaC"><meta name=description content="In the following post I will demonstrate getting started with the Terraform Azure Provider. I&rsquo;ll build the configuration for:
Resource Group Virtual Network Subnet Network Security Group (Allow SSH) NSG Association 2 x Linux Virtual Machines 2 x Network Interface Cards 2 x Public IPs These will all be deployed them from Azure Cloud Shell.
Remote vs Local State A quick note on the Terraform state file&mldr; I have decided to create a remote state file, stored in an Azure Storage Account in order to demonstrate the &ldquo;backend&rdquo; configuration."><meta name=author content="Mark kerry"><link rel=canonical href=https://markkerry.github.io/posts/2022/06/terraform-azure-provider/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png><link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.105.0"><script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script><meta property="og:title" content="Terraform Azure Provider"><meta property="og:description" content="In the following post I will demonstrate getting started with the Terraform Azure Provider. I&rsquo;ll build the configuration for:
Resource Group Virtual Network Subnet Network Security Group (Allow SSH) NSG Association 2 x Linux Virtual Machines 2 x Network Interface Cards 2 x Public IPs These will all be deployed them from Azure Cloud Shell.
Remote vs Local State A quick note on the Terraform state file&mldr; I have decided to create a remote state file, stored in an Azure Storage Account in order to demonstrate the &ldquo;backend&rdquo; configuration."><meta property="og:type" content="article"><meta property="og:url" content="https://markkerry.github.io/posts/2022/06/terraform-azure-provider/"><meta property="og:image" content="https://markkerry.github.io/images/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-05T10:01:49+00:00"><meta property="article:modified_time" content="2022-06-05T10:01:49+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markkerry.github.io/images/cover.png"><meta name=twitter:title content="Terraform Azure Provider"><meta name=twitter:description content="In the following post I will demonstrate getting started with the Terraform Azure Provider. I&rsquo;ll build the configuration for:
Resource Group Virtual Network Subnet Network Security Group (Allow SSH) NSG Association 2 x Linux Virtual Machines 2 x Network Interface Cards 2 x Public IPs These will all be deployed them from Azure Cloud Shell.
Remote vs Local State A quick note on the Terraform state file&mldr; I have decided to create a remote state file, stored in an Azure Storage Account in order to demonstrate the &ldquo;backend&rdquo; configuration."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Terraform Azure Provider","item":"https://markkerry.github.io/posts/2022/06/terraform-azure-provider/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform Azure Provider","name":"Terraform Azure Provider","description":"In the following post I will demonstrate getting started with the Terraform Azure Provider. I\u0026rsquo;ll build the configuration for:\nResource Group Virtual Network Subnet Network Security Group (Allow SSH) NSG Association 2 x Linux Virtual Machines 2 x Network Interface Cards 2 x Public IPs These will all be deployed them from Azure Cloud Shell.\nRemote vs Local State A quick note on the Terraform state file\u0026hellip; I have decided to create a remote state file, stored in an Azure Storage Account in order to demonstrate the \u0026ldquo;backend\u0026rdquo; configuration.","keywords":["Terraform","Azure","IaC"],"articleBody":"In the following post I will demonstrate getting started with the Terraform Azure Provider. I’ll build the configuration for:\nResource Group Virtual Network Subnet Network Security Group (Allow SSH) NSG Association 2 x Linux Virtual Machines 2 x Network Interface Cards 2 x Public IPs These will all be deployed them from Azure Cloud Shell.\nRemote vs Local State A quick note on the Terraform state file… I have decided to create a remote state file, stored in an Azure Storage Account in order to demonstrate the “backend” configuration.\nPrerequisites You would usually have to install VSCode, Terraform, Azure CLI and some VSCode extensions in order to build and deploy your terraform configurations, but for simplicity of this post I have decided to demonstrate the process using Azure Cloud Shell, as all of the prerequisites are installed. That being said, the only requirements to follow along are an Azure Storage Account to host both the state file and Azure Cloud Shell.\nSo to get started I created the following:\nResource Group Storage Account Container in the Storage Account called tf-state Log into the Azure Cloud Shell (Bash) and get going. Create a new terraform-demo directory as follows:\nmkdir terraform-demo \u0026\u0026 cd terraform-demo Providers You can include the “providers” configuration in the main.tf along with the configuration of resources, or you can put it in a separate file. I started by creating a providers.tf file.\ncode providers.tf Here I included the name and container of the storage account to hold the Terraform state file. The rest of the providers.tf file looks as follows:\nterraform { required_providers { azurerm = { source = \"hashicorp/azurerm\" version = \"=3.0.0\" } } backend \"azurerm\" { resource_group_name = \"rg-eu-stg\" storage_account_name = \"mkstgcqgtckq5sjjds\" container_name = \"tf-state\" key = \"terraform.tfstate\" } } provider \"azurerm\" { subscription_id = \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\" features {} } This is how it will look from the Cloud Shell. Make sure you change the subscription ID, or leave it out. Features has to be in the provider “block”, even if no features are specified.\nSave and close the editor when complete.\nVariables Next I created a variables.tf file to hold and prompt for values during deployment. Simply the “prefix” I want to give to name each resource, the location to deploy to (Default UK South), and the instance count (Number of VMs).\ncode variables.tf Which looks as follows:\nvariable \"prefix\" { description = \"Prefix for the resource names\" } variable \"location\" { default = \"UK South\" description = \"Region location for the resources\" } variable \"instance_count\" { description = \"Number of VMs to deploy\" } Save and close the editor when complete\nMain The main.tf file includes all the resources and the resource group. Notice ${var.prefix} being used for each resource name, and var.instance_count for the count.\ncode main.tf Which looks as follows:\n# create the resource group resource \"azurerm_resource_group\" \"rg\" { name = \"${var.prefix}-rg\" location = var.location } # create vNet resource \"azurerm_virtual_network\" \"vnet\" { name = \"${var.prefix}-vnet\" resource_group_name = azurerm_resource_group.rg.name location = azurerm_resource_group.rg.location address_space = [\"10.0.0.0/16\"] } # create Subnet resource \"azurerm_subnet\" \"internal\" { name = \"internal-subnet\" virtual_network_name = azurerm_virtual_network.vnet.name resource_group_name = azurerm_resource_group.rg.name address_prefixes = [\"10.0.1.0/24\"] } # create the nics resource \"azurerm_network_interface\" \"nics\" { count = var.instance_count name = \"${var.prefix}-vm${count.index}-nic\" location = azurerm_resource_group.rg.location resource_group_name = azurerm_resource_group.rg.name ip_configuration { name = \"internal\" subnet_id = azurerm_subnet.internal.id private_ip_address_allocation = \"Dynamic\" public_ip_address_id = element(azurerm_public_ip.pip.*.id, count.index) } } # create the pips resource \"azurerm_public_ip\" \"pip\" { count = var.instance_count name = \"${var.prefix}-vm${count.index}-pip\" resource_group_name = azurerm_resource_group.rg.name location = azurerm_resource_group.rg.location allocation_method = \"Dynamic\" } # create the nsg resource \"azurerm_network_security_group\" \"nsg\" { name = \"${var.prefix}-nsg\" location = azurerm_resource_group.rg.location resource_group_name = azurerm_resource_group.rg.name security_rule { name = \"ssh\" priority = 100 direction = \"Inbound\" access = \"Allow\" protocol = \"Tcp\" source_port_range = \"*\" destination_port_range = \"22\" source_address_prefix = \"*\" destination_address_prefix = \"*\" } } # associate the ngg with the nics resource \"azurerm_network_interface_security_group_association\" \"nsgassoc\" { count = var.instance_count network_interface_id = element(azurerm_network_interface.nics.*.id, count.index) network_security_group_id = azurerm_network_security_group.nsg.id } # create the vms resource \"azurerm_linux_virtual_machine\" \"vms\" { name = \"${var.prefix}-vm${count.index}\" count = var.instance_count resource_group_name = azurerm_resource_group.rg.name location = azurerm_resource_group.rg.location size = \"Standard_ds1_v2\" admin_username = \"admin-user\" network_interface_ids = [ element(azurerm_network_interface.nics.*.id, count.index) , ] admin_ssh_key { username = \"admin-user\" public_key = file(\"~/.ssh/id_rsa.pub\") } os_disk { caching = \"ReadWrite\" storage_account_type = \"Standard_LRS\" } source_image_reference { publisher = \"Canonical\" offer = \"UbuntuServer\" sku = \"19.04\" version = \"latest\" } } Save and close the editor when complete\nCreate SSH public-private key pair Notice in resource \"azurerm_linux_virtual_machine\" of main.tf there is admin_ssh_key which specifies file(\"~/.ssh/id_rsa.pub\"). I need to create this ssh key pair before deploying the VMs. To do this run the following:\nssh-keygen -m PEM -t rsa -b 4096 Accept the default path /home/user/.ssh/id_rsa which should match what’s in the main.tf file. Enter a passphrase which you will using when you ssh onto the VM once deployed\nDeploy Now it is time to deploy resources using Terraform. Start by initialising the local directory and remote backend. This will download the Azure provider and create a .terraform.lock.hcl file in the local directory. Then validate the configuration to check for any misconfigurations in the code.\nterraform init terraform validate Next you can create a plan. This will output what resources are to be added, changed, or destroyed. If you configure an “out” file, you can reference this file when you apply the terraform configuration, assuming the plan passes. This means it won’t need to run through another plan.\nterraform plan -out main.deploy.tfplan I entered a value of 2 and a prefix of markkerrytfdemo. It then stated the plan had detected 12 resources are to be added, 0 to change and 0 to destroy. The command to apply is also shown.\nSo, to apply the plan\nterraform apply \"main.deploy.tfplan\" NOTE: I had errors in my first deploy as I set the Ubuntu sku to 20.04. All resources except the VMs were created. This is invalid so I changed it to 19.04 and deployed it again. After I applied the plan again the final two resources were created\nThe resources looks as follows in Azure\nNOTE: I don’t like the look of the Network Security Group being named nsg1, so I will change the main.tf file to match the other resources\nIn the main.tf I changed name = \"nsg1\" to name = \"${var.prefix}-nsg\"\nIf I run terraform plan -out main.deploy.tfplan again I can see that the NSG, NSG Association, and NSG rule will be both destroyed and created again. And the Nics attached will have their NSG changed.\nThen finally, terraform apply main.deploy.tfplan again to change the NSG.\nI can test connectivity to one of the VMs using the SSH key. First gather the machine’s public IP and connect as follows:\nssh admin-user@public-ip Enter the passphrase you specified when generating the SSH Key Pair.\nAnd can see I am connected\nDestroy Once you have finished with the resources they can be “destroyed” by Terraform using the terraform plan -destroy command and then by applying the destroy plan.\nterraform plan -destroy -out=main.destroy.tfplan terraform apply main.destroy.tfplan Source Code All of the configuration files for this post can be found on GitHub.\n","wordCount":"1176","inLanguage":"en","image":"https://markkerry.github.io/images/cover.png","datePublished":"2022-06-05T10:01:49Z","dateModified":"2022-06-05T10:01:49Z","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/2022/06/terraform-azure-provider/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://markkerry.github.io/about/ title=About><span>About</span></a></li><li><a href=https://markkerry.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://markkerry.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>Terraform Azure Provider</h1><div class=post-meta>June 5, 2022&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Mark kerry</div></header><figure class=entry-cover><img loading=lazy srcset="https://markkerry.github.io/posts/2022/06/terraform-azure-provider/images/cover_hu6691cddeb8b41e38e64eb6367fd0f5e8_62479_360x0_resize_box_3.png 360w ,https://markkerry.github.io/posts/2022/06/terraform-azure-provider/images/cover_hu6691cddeb8b41e38e64eb6367fd0f5e8_62479_480x0_resize_box_3.png 480w ,https://markkerry.github.io/posts/2022/06/terraform-azure-provider/images/cover_hu6691cddeb8b41e38e64eb6367fd0f5e8_62479_720x0_resize_box_3.png 720w ,https://markkerry.github.io/posts/2022/06/terraform-azure-provider/images/cover_hu6691cddeb8b41e38e64eb6367fd0f5e8_62479_1080x0_resize_box_3.png 1080w ,https://markkerry.github.io/posts/2022/06/terraform-azure-provider/images/cover.png 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://markkerry.github.io/posts/2022/06/terraform-azure-provider/images/cover.png alt width=1200 height=487><p>Getting started using the Azure Provider for Terraform"</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#remote-vs-local-state aria-label="Remote vs Local State">Remote vs Local State</a></li><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li><li><a href=#providers aria-label=Providers>Providers</a></li><li><a href=#variables aria-label=Variables>Variables</a></li><li><a href=#main aria-label=Main>Main</a></li><li><a href=#create-ssh-public-private-key-pair aria-label="Create SSH public-private key pair">Create SSH public-private key pair</a></li><li><a href=#deploy aria-label=Deploy>Deploy</a></li><li><a href=#destroy aria-label=Destroy>Destroy</a></li><li><a href=#source-code aria-label="Source Code">Source Code</a></li></ul></div></details></div><div class=post-content><p>In the following post I will demonstrate getting started with the Terraform Azure Provider. I&rsquo;ll build the configuration for:</p><ul><li>Resource Group</li><li>Virtual Network</li><li>Subnet</li><li>Network Security Group (Allow SSH)</li><li>NSG Association</li><li>2 x Linux Virtual Machines</li><li>2 x Network Interface Cards</li><li>2 x Public IPs</li></ul><p>These will all be deployed them from Azure Cloud Shell.</p><h2 id=remote-vs-local-state>Remote vs Local State<a hidden class=anchor aria-hidden=true href=#remote-vs-local-state>#</a></h2><p>A quick note on the Terraform state file&mldr; I have decided to create a remote state file, stored in an Azure Storage Account in order to demonstrate the &ldquo;backend&rdquo; configuration.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><p>You would usually have to install VSCode, Terraform, Azure CLI and some VSCode extensions in order to build and deploy your terraform configurations, but for simplicity of this post I have decided to demonstrate the process using Azure Cloud Shell, as all of the prerequisites are installed. That being said, the only requirements to follow along are an Azure Storage Account to host both the state file and Azure Cloud Shell.</p><p>So to get started I created the following:</p><ul><li>Resource Group</li><li>Storage Account</li><li>Container in the Storage Account called <strong>tf-state</strong></li></ul><p>Log into the Azure Cloud Shell (Bash) and get going. Create a new terraform-demo directory as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>mkdir terraform-demo &amp;&amp; cd terraform-demo
</code></pre><h2 id=providers>Providers<a hidden class=anchor aria-hidden=true href=#providers>#</a></h2><p>You can include the &ldquo;providers&rdquo; configuration in the <strong>main.tf</strong> along with the configuration of resources, or you can put it in a separate file. I started by creating a <strong>providers.tf</strong> file.</p><pre tabindex=0><code class=language-termial data-lang=termial>code providers.tf
</code></pre><p>Here I included the name and container of the storage account to hold the Terraform state file. The rest of the <strong>providers.tf</strong> file looks as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>azurerm</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span>  = <span style=color:#e6db74>&#34;hashicorp/azurerm&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;=3.0.0&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>backend</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#e6db74>&#34;rg-eu-stg&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>storage_account_name</span> = <span style=color:#e6db74>&#34;mkstgcqgtckq5sjjds&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>container_name</span> = <span style=color:#e6db74>&#34;tf-state&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span> = <span style=color:#e6db74>&#34;terraform.tfstate&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subscription_id</span> = <span style=color:#e6db74>&#34;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>features</span> {}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is how it will look from the Cloud Shell. Make sure you change the subscription ID, or leave it out. Features has to be in the provider &ldquo;block&rdquo;, even if no features are specified.</p><p><img loading=lazy src=images/providers.png alt=providers></p><p>Save and close the editor when complete.</p><h2 id=variables>Variables<a hidden class=anchor aria-hidden=true href=#variables>#</a></h2><p>Next I created a <code>variables.tf</code> file to hold and prompt for values during deployment. Simply the &ldquo;prefix&rdquo; I want to give to name each resource, the location to deploy to (Default UK South), and the instance count (Number of VMs).</p><pre tabindex=0><code class=language-terminal data-lang=terminal>code variables.tf
</code></pre><p>Which looks as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;prefix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Prefix for the resource names&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;location&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span>     = <span style=color:#e6db74>&#34;UK South&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Region location for the resources&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;instance_count&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Number of VMs to deploy&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Save and close the editor when complete</p><h2 id=main>Main<a hidden class=anchor aria-hidden=true href=#main>#</a></h2><p>The <code>main.tf</code> file includes all the resources and the resource group. Notice <code>${var.prefix}</code> being used for each resource name, and <code>var.instance_count</code> for the count.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>code main.tf
</code></pre><p>Which looks as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#75715e># create the resource group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34;</span> <span style=color:#e6db74>&#34;rg&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>prefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-rg&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span> = var.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create vNet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_virtual_network&#34;</span> <span style=color:#e6db74>&#34;vnet&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>prefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-vnet&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>            = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>address_space</span>       = [<span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>]
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create Subnet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_subnet&#34;</span> <span style=color:#e6db74>&#34;internal&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                 = <span style=color:#e6db74>&#34;internal-subnet&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>virtual_network_name</span> = <span style=color:#a6e22e>azurerm_virtual_network</span>.<span style=color:#a6e22e>vnet</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span>  = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>address_prefixes</span>     = [<span style=color:#e6db74>&#34;10.0.1.0/24&#34;</span>]
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create the nics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34;</span> <span style=color:#e6db74>&#34;nics&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>count</span>               = var.<span style=color:#a6e22e>instance_count</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>prefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-vm</span><span style=color:#e6db74>${</span>count.<span style=color:#a6e22e>index</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-nic&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>            = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ip_configuration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>                          = <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>subnet_id</span>                     = <span style=color:#a6e22e>azurerm_subnet</span>.<span style=color:#a6e22e>internal</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>private_ip_address_allocation</span> = <span style=color:#e6db74>&#34;Dynamic&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>public_ip_address_id</span>          = element(<span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>pip</span>.<span style=color:#f92672>*</span>.<span style=color:#a6e22e>id</span>, count.<span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create the pips
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_public_ip&#34;</span> <span style=color:#e6db74>&#34;pip&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>count</span>               = var.<span style=color:#a6e22e>instance_count</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>prefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-vm</span><span style=color:#e6db74>${</span>count.<span style=color:#a6e22e>index</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-pip&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>            = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allocation_method</span>   = <span style=color:#e6db74>&#34;Dynamic&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create the nsg
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_security_group&#34;</span> <span style=color:#e6db74>&#34;nsg&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>prefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-nsg&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>            = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>security_rule</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>                       = <span style=color:#e6db74>&#34;ssh&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span>                   = <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>direction</span>                  = <span style=color:#e6db74>&#34;Inbound&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>access</span>                     = <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span>                   = <span style=color:#e6db74>&#34;Tcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source_port_range</span>          = <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>destination_port_range</span>     = <span style=color:#e6db74>&#34;22&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source_address_prefix</span>      = <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>destination_address_prefix</span> = <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># associate the ngg with the nics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34;</span> <span style=color:#e6db74>&#34;nsgassoc&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>count</span> = var.<span style=color:#a6e22e>instance_count</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network_interface_id</span>      = element(<span style=color:#a6e22e>azurerm_network_interface</span>.<span style=color:#a6e22e>nics</span>.<span style=color:#f92672>*</span>.<span style=color:#a6e22e>id</span>, count.<span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network_security_group_id</span> = <span style=color:#a6e22e>azurerm_network_security_group</span>.<span style=color:#a6e22e>nsg</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># create the vms
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_linux_virtual_machine&#34;</span> <span style=color:#e6db74>&#34;vms&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                  = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>prefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-vm</span><span style=color:#e6db74>${</span>count.<span style=color:#a6e22e>index</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>count</span>                 = var.<span style=color:#a6e22e>instance_count</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource_group_name</span>   = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>              = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>rg</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>size</span>                  = <span style=color:#e6db74>&#34;Standard_ds1_v2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>admin_username</span>        = <span style=color:#e6db74>&#34;admin-user&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network_interface_ids</span> = [
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>element</span>(<span style=color:#a6e22e>azurerm_network_interface</span>.<span style=color:#a6e22e>nics</span>.<span style=color:#f92672>*</span>.<span style=color:#a6e22e>id</span>, count.<span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>admin_ssh_key</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span>   = <span style=color:#e6db74>&#34;admin-user&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>public_key</span> = file(<span style=color:#e6db74>&#34;~/.ssh/id_rsa.pub&#34;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>os_disk</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>caching</span>              = <span style=color:#e6db74>&#34;ReadWrite&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>storage_account_type</span> = <span style=color:#e6db74>&#34;Standard_LRS&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source_image_reference</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>publisher</span> = <span style=color:#e6db74>&#34;Canonical&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>offer</span>     = <span style=color:#e6db74>&#34;UbuntuServer&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sku</span>       = <span style=color:#e6db74>&#34;19.04&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>version</span>   = <span style=color:#e6db74>&#34;latest&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Save and close the editor when complete</p><h2 id=create-ssh-public-private-key-pair>Create SSH public-private key pair<a hidden class=anchor aria-hidden=true href=#create-ssh-public-private-key-pair>#</a></h2><p>Notice in <code>resource "azurerm_linux_virtual_machine"</code> of <strong>main.tf</strong> there is <code>admin_ssh_key</code> which specifies <code>file("~/.ssh/id_rsa.pub")</code>. I need to create this ssh key pair before deploying the VMs. To do this run the following:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ssh-keygen -m PEM -t rsa -b 4096
</code></pre><p>Accept the default path <code>/home/user/.ssh/id_rsa</code> which should match what&rsquo;s in the <strong>main.tf</strong> file. Enter a passphrase which you will using when you ssh onto the VM once deployed</p><p><img loading=lazy src=images/sshKeygen.png alt=ssh></p><h2 id=deploy>Deploy<a hidden class=anchor aria-hidden=true href=#deploy>#</a></h2><p>Now it is time to deploy resources using Terraform. Start by initialising the local directory and remote backend. This will download the Azure provider and create a <code>.terraform.lock.hcl</code> file in the local directory. Then validate the configuration to check for any misconfigurations in the code.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>terraform init
terraform validate
</code></pre><p><img loading=lazy src=images/initValidate.png alt=init></p><p>Next you can create a plan. This will output what resources are to be added, changed, or destroyed. If you configure an &ldquo;out&rdquo; file, you can reference this file when you apply the terraform configuration, assuming the plan passes. This means it won&rsquo;t need to run through another plan.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>terraform plan -out main.deploy.tfplan
</code></pre><p><img loading=lazy src=images/plan1.png alt=plan1></p><p>I entered a value of <code>2</code> and a prefix of <code>markkerrytfdemo</code>. It then stated the plan had detected 12 resources are to be added, 0 to change and 0 to destroy. The command to apply is also shown.</p><p><img loading=lazy src=images/plan2.png alt=plan2></p><p>So, to apply the plan</p><pre tabindex=0><code class=language-terminal data-lang=terminal>terraform apply &#34;main.deploy.tfplan&#34;
</code></pre><blockquote><p>NOTE: I had errors in my first deploy as I set the Ubuntu sku to 20.04. All resources except the VMs were created. This is invalid so I changed it to 19.04 and deployed it again. After I applied the plan again the final two resources were created</p></blockquote><p><img loading=lazy src=images/apply1.png alt=apply></p><p>The resources looks as follows in Azure</p><p><img loading=lazy src=images/resources1.png alt=resources></p><blockquote><p>NOTE: I don&rsquo;t like the look of the Network Security Group being named <strong>nsg1</strong>, so I will change the main.tf file to match the other resources</p></blockquote><p>In the <code>main.tf</code> I changed <code>name = "nsg1"</code> to <code>name = "${var.prefix}-nsg"</code></p><p><img loading=lazy src=images/updateMainNsg.png alt=updateNsg></p><p>If I run <code>terraform plan -out main.deploy.tfplan</code> again I can see that the NSG, NSG Association, and NSG rule will be both destroyed and created again. And the Nics attached will have their NSG changed.</p><p><img loading=lazy src=images/plan3.png alt=plan3></p><p>Then finally, <code>terraform apply main.deploy.tfplan</code> again to change the NSG.</p><p><img loading=lazy src=images/resources2.png alt=resources2></p><p>I can test connectivity to one of the VMs using the SSH key. First gather the machine&rsquo;s public IP and connect as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ssh admin-user@public-ip
</code></pre><p>Enter the passphrase you specified when generating the SSH Key Pair.</p><p><img loading=lazy src=images/sshAdminUser.png alt=ssh></p><p>And can see I am connected</p><p><img loading=lazy src=images/linuxCmd.png alt=linuxCmd></p><h2 id=destroy>Destroy<a hidden class=anchor aria-hidden=true href=#destroy>#</a></h2><p>Once you have finished with the resources they can be &ldquo;destroyed&rdquo; by Terraform using the <code>terraform plan -destroy</code> command and then by applying the destroy plan.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>terraform plan -destroy -out=main.destroy.tfplan
</code></pre><p><img loading=lazy src=images/destroy.png alt=destroy></p><pre tabindex=0><code class=language-terminal data-lang=terminal>terraform apply main.destroy.tfplan
</code></pre><p><img loading=lazy src=images/destroy2.png alt=destroy2></p><h2 id=source-code>Source Code<a hidden class=anchor aria-hidden=true href=#source-code>#</a></h2><p>All of the configuration files for this post can be found on <a href=https://github.com/markkerry/terraform-azure-provider>GitHub</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://markkerry.github.io/tags/terraform/>Terraform</a></li><li><a href=https://markkerry.github.io/tags/azure/>Azure</a></li><li><a href=https://markkerry.github.io/tags/iac/>IaC</a></li></ul><nav class=paginav><a class=prev href=https://markkerry.github.io/posts/2022/07/cs50p-programming-with-python/><span class=title>« Prev Page</span><br><span>CS50P Introduction to Programming with Python Final Project</span></a>
<a class=next href=https://markkerry.github.io/posts/2022/05/terraform-virtualbox-provider/><span class=title>Next Page »</span><br><span>Terraform VirtualBox Provider</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>