<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deploy an ASP.NET Core Web App to an AKS Cluster | markkerry.github.io</title><meta name=keywords content="Azure,AKS,Kubernetes,ASP.NET Core"><meta name=description content="In this post I will demonstrate containerising a simple ASP.NET Core web app, pushing it to an Azure Container Registry (ACR), and then running it in a two-node Azure Kubernetes Service (AKS) cluster. It&rsquo;s not too CLI heavy, and has a lot of manual steps. But it&rsquo;s a good insight into the end-to-end process of how you can develop and test an app in AKS.
The prerequisites you will need installed on your machine:"><meta name=author content="Mark kerry"><link rel=canonical href=https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png><link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script><meta property="og:title" content="Deploy an ASP.NET Core Web App to an AKS Cluster"><meta property="og:description" content="In this post I will demonstrate containerising a simple ASP.NET Core web app, pushing it to an Azure Container Registry (ACR), and then running it in a two-node Azure Kubernetes Service (AKS) cluster. It&rsquo;s not too CLI heavy, and has a lot of manual steps. But it&rsquo;s a good insight into the end-to-end process of how you can develop and test an app in AKS.
The prerequisites you will need installed on your machine:"><meta property="og:type" content="article"><meta property="og:url" content="https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/"><meta property="og:image" content="https://markkerry.github.io/media/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-20T12:09:21+00:00"><meta property="article:modified_time" content="2022-11-20T12:09:21+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markkerry.github.io/media/cover.png"><meta name=twitter:title content="Deploy an ASP.NET Core Web App to an AKS Cluster"><meta name=twitter:description content="In this post I will demonstrate containerising a simple ASP.NET Core web app, pushing it to an Azure Container Registry (ACR), and then running it in a two-node Azure Kubernetes Service (AKS) cluster. It&rsquo;s not too CLI heavy, and has a lot of manual steps. But it&rsquo;s a good insight into the end-to-end process of how you can develop and test an app in AKS.
The prerequisites you will need installed on your machine:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Deploy an ASP.NET Core Web App to an AKS Cluster","item":"https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploy an ASP.NET Core Web App to an AKS Cluster","name":"Deploy an ASP.NET Core Web App to an AKS Cluster","description":"In this post I will demonstrate containerising a simple ASP.NET Core web app, pushing it to an Azure Container Registry (ACR), and then running it in a two-node Azure Kubernetes Service (AKS) cluster. It\u0026rsquo;s not too CLI heavy, and has a lot of manual steps. But it\u0026rsquo;s a good insight into the end-to-end process of how you can develop and test an app in AKS.\nThe prerequisites you will need installed on your machine:","keywords":["Azure","AKS","Kubernetes","ASP.NET Core"],"articleBody":"In this post I will demonstrate containerising a simple ASP.NET Core web app, pushing it to an Azure Container Registry (ACR), and then running it in a two-node Azure Kubernetes Service (AKS) cluster. It’s not too CLI heavy, and has a lot of manual steps. But it’s a good insight into the end-to-end process of how you can develop and test an app in AKS.\nThe prerequisites you will need installed on your machine:\nVisual Studio 2022 Community or Professional Or Visual Studio Code with .Net 6.0 SDK AZ CLI or just use the Cloud Shell Docker Desktop if debugging the container locally in Visual Studio WSL 2 and Ubuntu if running on Windows This guide does assume you have a basic understanding of creating Azure resources in the portal, such as resource groups, AKS, and ACRs.\nCreate Azure Container Registry Start by creating a resource group and an ACR. I created a resource group named rg-uk-aks-demo and named the container registry acrmkmsdn. I chose UK South as it’s closest to me.\nCreate AKS Cluster Now create an AKS cluster in the Azure portal. A few things to note which you will need to select: On the Basics tab, choose the cluster pre-set configuration, availability zones, and the API availability which works for your budget. Also change the Node size and scale method if you want to reduce costs. I chose Standard_B2s as the node size. On the Integrations tab, select the ACR you created earlier. And I think the rest of the configuration you can leave as the default.\nCreate ASP.NET Core App with Docker Support Now the infrastructure has been created, we can create the ASP.NET Core web app. I simply opened Visual Studio Community 2022 and selected Create a new project \u003e ASP.NET Core Web App. I named it as follows:\nThen ensure you select the following:\nFramework: .NET 6.0 (Long Term Support) Tick Enable Docker Docker OS: Linux Once the new project has been created you should notice a Dockerfile in the root of the solution, which will look as follows:\nFROM mcr.microsoft.com/dotnet/aspnet:6.0 AS base WORKDIR /app EXPOSE 80 EXPOSE 443 FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build WORKDIR /src COPY [\"ASP-Docker-App/ASP-Docker-App.csproj\", \"ASP-Docker-App/\"] RUN dotnet restore \"ASP-Docker-App/ASP-Docker-App.csproj\" COPY . . WORKDIR \"/src/ASP-Docker-App\" RUN dotnet build \"ASP-Docker-App.csproj\" -c Release -o /app/build FROM build AS publish RUN dotnet publish \"ASP-Docker-App.csproj\" -c Release -o /app/publish /p:UseAppHost=false FROM base AS final WORKDIR /app COPY --from=publish /app/publish . ENTRYPOINT [\"dotnet\", \"ASP-Docker-App.dll\"] There is nothing to change here. This will be used to build the container image before it is pushed to the container registry. Now browse to Pages \u003e Index.cshtml.\nThis is optional but I changed the text displayed as follows:\n@page @model IndexModel @{ ViewData[\"Title\"] = \"Home page\"; } \u003cdiv class=\"text-center\"\u003e \u003ch1 class=\"display-4\"\u003eASP.NET Core App running on AKS\u003c/h1\u003e \u003cp\u003eThis containerised ASP.NET Core app is running on an AKS Cluster\u003c/p\u003e \u003c/div\u003e Save and close Index.cshtml if applicable.\nPublish Container to ACR Once you are happy with your APS.NET Core Web App you can publish it to the ACR. You will need to ensure you are signed into Visual Studio with the Account which has access to the Azure Subscriptions you are wanting to deploy to. Once you have signed in, select Build \u003e Publish. Select Docker Container Registry and click Next.\nSelect Azure Container Registry and click Next.\nOnce you select your Subscription, The registry we created earlier and the resource group it is in should be detected. Select it and click Finish.\nClick Close when prompted.\nAnd when you are ready click Publish.\nYou will see in the Output window the container being built and pushed to the ACR.\nDeploy Container Image to AKS Now we can deploy container to the AKS cluster. Start by opening the Azure portal, browsing to the Subscription and opening the Cloud Shell (BASH). We will use the kubectl tool to manage the cluster.\nYou need to gather the credentials in order to interact with the cluster using kubectl in Azure Cloud Shell. I used the following command:\naz aks get-credentials --resource-group rg-uk-aks-demo --name aks-uk-demo-msdn You can review the credentials with the following command:\ncat .kube/config Note: If you forgot to attach the ACR when creating the AKS resource (Like I did the first time), you can attach it after. I had to use the following command: az aks update -n aks-uk-demo-msdn -g rg-uk-aks-demo --attach-acr acrmkmsdn\nNow in the Cloud Shell, create a new file called deploy.yaml as follows:\ncode deploy.yaml Then I pasted in the following Kubernetes Deployment and Service configurations. Note, change yours to match your app name, container name, registry, etc.\napiVersion: apps/v1 kind: Deployment metadata: name: asp-docker-app spec: replicas: 2 selector: matchLabels: app: asp-docker-app template: metadata: labels: app: asp-docker-app spec: containers: - name: asp-docker-app image: acrmkmsdn.azurecr.io/aspdockerapp:latest --- apiVersion: v1 kind: Service metadata: name: asp-docker-app spec: type: LoadBalancer ports: - port: 80 targetPort: 80 protocol: TCP selector: app: asp-docker-app Once you save and close the code editor, it’s finally time to apply the configuration:\nkubectl apply -f deploy.yaml Notice the deployment and service shows as created.\nYou can run the following commands:\nkubectl get pods kubectl get nodes kubectl get service kubectl describe deployment Or just run:\nkubectl get all This will show the pods, services, apps and replica sets.\nWe can see the EXTERNAL-IP of the LoadBalancer above as being 20.117.254.138 and the port as 80. I should now be able to use this to browse the the web app running on AKS.\nIf we head over to the Azure portal, select the AKS resource \u003e Workloads \u003e asp-docker-app, we can see the pods.\nAnd that’s it, the containerised ASP.NET Core Web App is running on the AKS cluster.\nDelete deployment If you want to clean up the cluster, you can run the following commands:\nkubectl delete -f deploy.yaml kubectl delete svc asp-docker-app --namespace=default Delete the Resources Don’t forget to delete the resources you created if you are not longer using them.\n","wordCount":"988","inLanguage":"en","image":"https://markkerry.github.io/media/cover.png","datePublished":"2022-11-20T12:09:21Z","dateModified":"2022-11-20T12:09:21Z","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://markkerry.github.io/about/ title=About><span>About</span></a></li><li><a href=https://markkerry.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://markkerry.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>Deploy an ASP.NET Core Web App to an AKS Cluster</h1><div class=post-meta><span title='2022-11-20 12:09:21 +0000 UTC'>November 20, 2022</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Mark kerry</div></header><figure class=entry-cover><img loading=lazy srcset="https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/media/cover_hu7b0f540beb8b54e1360c9f72410248e3_52841_360x0_resize_box_3.png 360w ,https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/media/cover_hu7b0f540beb8b54e1360c9f72410248e3_52841_480x0_resize_box_3.png 480w ,https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/media/cover.png 677w" sizes="(min-width: 768px) 720px, 100vw" src=https://markkerry.github.io/posts/2022/11/deploy-aspcore-app-to-aks/media/cover.png alt width=677 height=258><p>Deploy a containerised ASP.NET Core Web App to Azure Kubernetes Service</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#create-azure-container-registry aria-label="Create Azure Container Registry">Create Azure Container Registry</a></li><li><a href=#create-aks-cluster aria-label="Create AKS Cluster">Create AKS Cluster</a></li><li><a href=#create-aspnet-core-app-with-docker-support aria-label="Create ASP.NET Core App with Docker Support">Create ASP.NET Core App with Docker Support</a></li><li><a href=#publish-container-to-acr aria-label="Publish Container to ACR">Publish Container to ACR</a></li><li><a href=#deploy-container-image-to-aks aria-label="Deploy Container Image to AKS">Deploy Container Image to AKS</a></li><li><a href=#delete-deployment aria-label="Delete deployment">Delete deployment</a></li><li><a href=#delete-the-resources aria-label="Delete the Resources">Delete the Resources</a></li></ul></div></details></div><div class=post-content><p>In this post I will demonstrate containerising a simple ASP.NET Core web app, pushing it to an Azure Container Registry (ACR), and then running it in a two-node Azure Kubernetes Service (AKS) cluster. It&rsquo;s not too CLI heavy, and has a lot of manual steps. But it&rsquo;s a good insight into the end-to-end process of how you can develop and test an app in AKS.</p><p>The prerequisites you will need installed on your machine:</p><ul><li>Visual Studio 2022 Community or Professional</li><li>Or Visual Studio Code with .Net 6.0 SDK</li><li>AZ CLI or just use the Cloud Shell</li><li>Docker Desktop if debugging the container locally in Visual Studio</li><li>WSL 2 and Ubuntu if running on Windows</li></ul><p>This guide does assume you have a basic understanding of creating Azure resources in the portal, such as resource groups, AKS, and ACRs.</p><h2 id=create-azure-container-registry>Create Azure Container Registry<a hidden class=anchor aria-hidden=true href=#create-azure-container-registry>#</a></h2><p>Start by creating a resource group and an ACR. I created a resource group named <strong>rg-uk-aks-demo</strong> and named the container registry <strong>acrmkmsdn</strong>. I chose UK South as it&rsquo;s closest to me.</p><h2 id=create-aks-cluster>Create AKS Cluster<a hidden class=anchor aria-hidden=true href=#create-aks-cluster>#</a></h2><p>Now create an AKS cluster in the Azure portal. A few things to note which you will need to select: On the Basics tab, choose the cluster pre-set configuration, availability zones, and the API availability which works for your budget. Also change the Node size and scale method if you want to reduce costs. I chose Standard_B2s as the node size. On the Integrations tab, select the ACR you created earlier. And I think the rest of the configuration you can leave as the default.</p><h2 id=create-aspnet-core-app-with-docker-support>Create ASP.NET Core App with Docker Support<a hidden class=anchor aria-hidden=true href=#create-aspnet-core-app-with-docker-support>#</a></h2><p>Now the infrastructure has been created, we can create the ASP.NET Core web app. I simply opened Visual Studio Community 2022 and selected <strong>Create a new project</strong> > <strong>ASP.NET Core Web App</strong>. I named it as follows:</p><p><img loading=lazy src=media/newProject.png alt=newProject></p><p>Then ensure you select the following:</p><ul><li>Framework: <strong>.NET 6.0 (Long Term Support)</strong></li><li>Tick <strong>Enable Docker</strong></li><li>Docker OS: <strong>Linux</strong></li></ul><p><img loading=lazy src=media/newProject2.png alt=newProject2></p><p>Once the new project has been created you should notice a <code>Dockerfile</code> in the root of the solution, which will look as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/dotnet/aspnet:6.0 AS base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 80</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 443</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/dotnet/sdk:6.0 AS build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /src</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;ASP-Docker-App/ASP-Docker-App.csproj&#34;</span>, <span style=color:#e6db74>&#34;ASP-Docker-App/&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet restore <span style=color:#e6db74>&#34;ASP-Docker-App/ASP-Docker-App.csproj&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> &#34;/src/ASP-Docker-App&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet build <span style=color:#e6db74>&#34;ASP-Docker-App.csproj&#34;</span> -c Release -o /app/build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> build AS publish</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet publish <span style=color:#e6db74>&#34;ASP-Docker-App.csproj&#34;</span> -c Release -o /app/publish /p:UseAppHost<span style=color:#f92672>=</span>false<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS final</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>publish /app/publish .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;dotnet&#34;</span>, <span style=color:#e6db74>&#34;ASP-Docker-App.dll&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>There is nothing to change here. This will be used to build the container image before it is pushed to the container registry. Now browse to Pages > Index.cshtml.</p><p><img loading=lazy src=media/projectLayout.png alt=projectLayout></p><p>This is optional but I changed the text displayed as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>@page
</span></span><span style=display:flex><span>@model IndexModel
</span></span><span style=display:flex><span>@{
</span></span><span style=display:flex><span>    ViewData[&#34;Title&#34;] = &#34;Home page&#34;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text-center&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>h1</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;display-4&#34;</span>&gt;ASP.NET Core App running on AKS&lt;/<span style=color:#f92672>h1</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>p</span>&gt;This containerised ASP.NET Core app is running on an AKS Cluster&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span></code></pre></div><p>Save and close Index.cshtml if applicable.</p><h2 id=publish-container-to-acr>Publish Container to ACR<a hidden class=anchor aria-hidden=true href=#publish-container-to-acr>#</a></h2><p>Once you are happy with your APS.NET Core Web App you can publish it to the ACR. You will need to ensure you are signed into Visual Studio with the Account which has access to the Azure Subscriptions you are wanting to deploy to. Once you have signed in, select <strong>Build</strong> > <strong>Publish</strong>. Select <strong>Docker Container Registry</strong> and click <strong>Next</strong>.</p><p><img loading=lazy src=media/pub0.png alt=pub0></p><p>Select <strong>Azure Container Registry</strong> and click <strong>Next</strong>.</p><p><img loading=lazy src=media/pub1.png alt=pub1></p><p>Once you select your Subscription, The registry we created earlier and the resource group it is in should be detected. Select it and click <strong>Finish</strong>.</p><p><img loading=lazy src=media/pub2.png alt=pub2></p><p>Click <strong>Close</strong> when prompted.</p><p><img loading=lazy src=media/pub3.png alt=pub3></p><p>And when you are ready click <strong>Publish</strong>.</p><p><img loading=lazy src=media/pub4.png alt=pub4></p><p>You will see in the Output window the container being built and pushed to the ACR.</p><p><img loading=lazy src=media/pub5.png alt=pub5></p><h2 id=deploy-container-image-to-aks>Deploy Container Image to AKS<a hidden class=anchor aria-hidden=true href=#deploy-container-image-to-aks>#</a></h2><p>Now we can deploy container to the AKS cluster. Start by opening the Azure portal, browsing to the Subscription and opening the Cloud Shell (BASH). We will use the <code>kubectl</code> tool to manage the cluster.</p><p>You need to gather the credentials in order to interact with the cluster using <code>kubectl</code> in Azure Cloud Shell. I used the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az aks get-credentials --resource-group rg-uk-aks-demo --name aks-uk-demo-msdn
</span></span></code></pre></div><p>You can review the credentials with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat .kube/config
</span></span></code></pre></div><blockquote><p><strong>Note:</strong> If you forgot to attach the ACR when creating the AKS resource (Like I did the first time), you can attach it after. I had to use the following command: <code>az aks update -n aks-uk-demo-msdn -g rg-uk-aks-demo --attach-acr acrmkmsdn</code></p></blockquote><p>Now in the Cloud Shell, create a new file called deploy.yaml as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>code deploy.yaml
</span></span></code></pre></div><p>Then I pasted in the following Kubernetes Deployment and Service configurations. Note, change yours to match your app name, container name, registry, etc.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>asp-docker-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>asp-docker-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>asp-docker-app</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>asp-docker-app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>acrmkmsdn.azurecr.io/aspdockerapp:latest</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>asp-docker-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>LoadBalancer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>asp-docker-app</span>
</span></span></code></pre></div><p>Once you save and close the code editor, it&rsquo;s finally time to apply the configuration:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>kubectl apply -f deploy.yaml
</code></pre><p>Notice the deployment and service shows as <strong>created</strong>.</p><p><img loading=lazy src=media/deploy.png alt=deploy></p><p>You can run the following commands:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>kubectl get pods
kubectl get nodes
kubectl get service
kubectl describe deployment
</code></pre><p>Or just run:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>kubectl get all
</code></pre><p>This will show the pods, services, apps and replica sets.</p><p><img loading=lazy src=media/getAll.png alt=getAll></p><p>We can see the <strong>EXTERNAL-IP</strong> of the LoadBalancer above as being 20.117.254.138 and the port as 80. I should now be able to use this to browse the the web app running on AKS.</p><p><img loading=lazy src=media/runningApp.png alt=runningApp></p><p>If we head over to the Azure portal, select the AKS resource > Workloads > asp-docker-app, we can see the pods.</p><p><img loading=lazy src=media/workloads.png alt=workloads></p><p>And that&rsquo;s it, the containerised ASP.NET Core Web App is running on the AKS cluster.</p><h2 id=delete-deployment>Delete deployment<a hidden class=anchor aria-hidden=true href=#delete-deployment>#</a></h2><p>If you want to clean up the cluster, you can run the following commands:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>kubectl delete -f deploy.yaml
kubectl delete svc asp-docker-app --namespace=default
</code></pre><h2 id=delete-the-resources>Delete the Resources<a hidden class=anchor aria-hidden=true href=#delete-the-resources>#</a></h2><p>Don&rsquo;t forget to delete the resources you created if you are not longer using them.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://markkerry.github.io/tags/azure/>Azure</a></li><li><a href=https://markkerry.github.io/tags/aks/>AKS</a></li><li><a href=https://markkerry.github.io/tags/kubernetes/>Kubernetes</a></li><li><a href=https://markkerry.github.io/tags/asp.net-core/>ASP.NET Core</a></li></ul><nav class=paginav><a class=prev href=https://markkerry.github.io/posts/2023/04/deploy-automation-runbook-with-powershell/><span class=title>« Prev</span><br><span>Deploy an Azure Automation Runbook With PowerShell</span></a>
<a class=next href=https://markkerry.github.io/posts/2022/08/ado-terraform-build/><span class=title>Next »</span><br><span>Terraform in Azure DevOps Pipelines</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>