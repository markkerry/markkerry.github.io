<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible Part 2: Playbooks | markkerry.github.io</title><meta name=keywords content="Linux,Ubuntu,VirtualBox,Ansible,Apache"><meta name=description content="In this post I&rsquo;ll be going over Ansible Playbooks. The complete list of posts in this series are:
 Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox Ansible Part 2: Playbooks (This post) Ansible Part 3: Variables, Vault and Roles  All code in these posts can be found on GitHub - ubuntu-config/ansible
Playbooks Playbooks allow us to write ordered process and manage configurations in the form of yaml syntax."><meta name=author content="Mark kerry"><link rel=canonical href=https://markkerry.github.io/posts/2022/04/ansible-part-2/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png><link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.98.0"><script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config",'')</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script><meta property="og:title" content="Ansible Part 2: Playbooks"><meta property="og:description" content="In this post I&rsquo;ll be going over Ansible Playbooks. The complete list of posts in this series are:
 Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox Ansible Part 2: Playbooks (This post) Ansible Part 3: Variables, Vault and Roles  All code in these posts can be found on GitHub - ubuntu-config/ansible
Playbooks Playbooks allow us to write ordered process and manage configurations in the form of yaml syntax."><meta property="og:type" content="article"><meta property="og:url" content="https://markkerry.github.io/posts/2022/04/ansible-part-2/"><meta property="og:image" content="https://markkerry.github.io/images/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-03T10:31:05+00:00"><meta property="article:modified_time" content="2022-04-03T10:31:05+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://markkerry.github.io/images/cover.png"><meta name=twitter:title content="Ansible Part 2: Playbooks"><meta name=twitter:description content="In this post I&rsquo;ll be going over Ansible Playbooks. The complete list of posts in this series are:
 Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox Ansible Part 2: Playbooks (This post) Ansible Part 3: Variables, Vault and Roles  All code in these posts can be found on GitHub - ubuntu-config/ansible
Playbooks Playbooks allow us to write ordered process and manage configurations in the form of yaml syntax."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Ansible Part 2: Playbooks","item":"https://markkerry.github.io/posts/2022/04/ansible-part-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible Part 2: Playbooks","name":"Ansible Part 2: Playbooks","description":"In this post I\u0026rsquo;ll be going over Ansible Playbooks. The complete list of posts in this series are:\n Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox Ansible Part 2: Playbooks (This post) Ansible Part 3: Variables, Vault and Roles  All code in these posts can be found on GitHub - ubuntu-config/ansible\nPlaybooks Playbooks allow us to write ordered process and manage configurations in the form of yaml syntax.","keywords":["Linux","Ubuntu","VirtualBox","Ansible","Apache"],"articleBody":"In this post I’ll be going over Ansible Playbooks. The complete list of posts in this series are:\n Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox Ansible Part 2: Playbooks (This post) Ansible Part 3: Variables, Vault and Roles  All code in these posts can be found on GitHub - ubuntu-config/ansible\nPlaybooks Playbooks allow us to write ordered process and manage configurations in the form of yaml syntax. These can then be used to build out remote systems. “Configuration as code” means the playbook yaml files can sit in source control and be integrated with CI/CD pipelines.\nYou need to create a Playbook listing everything you want to apply to each instance. And since playbooks run from top to bottom, they need to be in a logically defined order.\nPlaybooks are made of up “plays” so we can include the “tasks” performed in part 1 as plays in the playbook.\nFor example the ping task: ansible -m ping all can be written as a play in a playbook as follows\n# ping.yaml ---  - hosts: all  tasks:  - name: Ping all servers  action: ping This can then be invoked with ansible-playbook ping.yaml\nCreate a playbook Now let’s create some playbooks.\nmkdir ~/ansible/playbooks Can update the apt repos with the following playbook.\nvim playbooks/apt-update.yaml Then populate\n# apt-update.yaml ---  - hosts: webservers:loadbalancers  become: true  tasks:  - name Update apt packages  apt: name=* state=latest Notice the become: true. This means become root (sudo), as the apt commands require sudo. Without it the playbook would run as follows.\nSo with become: true defined it’s time to run the playbook as follows:\nansible-playbook playbooks/apt-update.yaml -K The -K means “ask for become password”.\nSetup the servers Now it’s time to configure the Ubuntu servers; one load balancer and two web servers. All three servers will require Apache installed, however the load balancer will require the following Apache Modules which to be installed manually would be:\nsudo a2enmod proxy sudo a2enmod proxy_http sudo a2enmod lbmethod_byrequests sudo a2enmod proxy_balancer sudo systemctl restart apache2 But I will incorporate the Apache Modules required for a load balancer in the playbook. Also the web servers will require php in order to be able to host the custom index.php file I’ll be deploying to them. Create the playbook as follows:\nvim playbooks/install-services.yaml The install-services.yaml looks as follows:\n# install-services.yaml ---  - hosts: loadbalancers  become: true  tasks:  - name: Installing apache  apt: name=apache2 state=present  - name: Ensure apache starts  service: name=apache2 state=started enabled=yes  - name: Enable lbmethod_byrequests apache module  community.general.apache2_module:  state: present  name: lbmethod_byrequests  - name: Enable proxy_balancer apache module  community.general.apache2_module:  state: present  name: proxy_balancer  - name: Enable proxy_http apache module  community.general.apache2_module:  state: present  name: proxy_http  - name: Enable proxy apache module  community.general.apache2_module:  state: present  name: proxy   - hosts: webservers  become: true  tasks:  - name: Installing apache  apt: name=apache2 state=present  - name: Install software-properties-common  apt: name=software-properties-common  - name: Add repo php  apt_repository: repo=\"ppa:ondrej/php\"  - name: Updating the repo  apt: update_cache=yes  - name: Installing php  apt: name=php state=present  - name: Ensure apache starts  service: name=apache2 state=started enabled=yes And once saved it is time to test it:\nansible-playbook playbooks/install-services.yaml -K Now that all three servers have the required applications installed it is time to configure them.\nConfigure the Load Balancer I’ll start by creating a new directory to host any configuration files:\nmkdir ~/ansible/config \u0026\u0026 cd ~/ansible/config Then create a new “jinger2” syntax file which will will be deployed to the load balancer to configure it.\nvim lb-config.j2 The contents of lb-config.j2 file are below. Notice there is some “for loop” logic which is going through each “webserver” host in the hosts-dev file. This means the servers do not need to be hard coded in this file and the file does not need to be updated when any web servers are added or deleted.\nProxyRequests off  {% for hosts in groups['webservers'] %}  BalancerMember http://{{hostvars[hosts]['ansible_host']}}  {% endfor %}  ProxySet lbmethod=byrequests   # Optional  SetHandler balancer-manager   ProxyPass /balancer-manager ! ProxyPass / balancer://webcluster/ Now that the lb-config.j2 file has been created, we can create a playbook to deploy it the the load balancer, set the permissions and then restart Apache.\nvim ./playbooks/lb-setup.yaml Here is the contents of lb-setup.yaml\n---  - hosts: loadbalancers  become: true  tasks:  - name: Creating template  template:  src: ../config/lb-config.j2  dest: /etc/apache2/conf-enabled/lb.conf  owner: root  group: root  mode: 064  - name: restart apache  service: name=apache2 state=restarted Run the playbook:\nansible-playbook playbooks/lb-setup.yaml -K That’s all that is required to configure the load balancer.\nConfigure the Web Servers To configure the web servers, I’m simply going to deploy an index.php file and delete the index.html from the default Apache /var/www/html/ directory.\nCreate the php file in the ansible directory as follows:\nvim index.php The index.php file will simply use a function to gather the webservers hostname, print in bold that the site has been configured by Ansible, then display the hostname. This way we can prove the load balancer is working correctly:\nphp  $hostname = gethostname();  echo \"Site configured by Ansible\";  echo \"Webserver: $hostname\"; ?Now that the index.php file has been created, we can create a playbook to deploy it the the web servers, set the permissions, delete the old index.html, and then restart Apache.\nvim ./playbooks/app-setup.yaml The content of the app-setup.yaml file is below. Notice the notify and handlers section. This means that if anything is changed in the the name play then to notify the handler. This particular handler will restart Apache if notified.\n# app-setup.yaml ---  - hosts: webservers  become: true  tasks:  - name: Copy app files  copy:  src: ../index.php  dest: /var/www/html  mode: 0755  notify: restart apache   - name: Delete index.html  ansible.builtin.file:  path: /var/www/html/index.html  state: absent  notify: restart apache   handlers:  - name: restart apache  service: name=apache2 state=restarted Run the playbook:\nansible-playbook playbooks/app-setup.yaml -K And that is all that is required to configure the web servers.\nRun All Playbooks That’s quite a few playbooks created in the post. We can combine them all together and deploy them in one playbook using import_playbook. I created a new playbook as follows:\nvim playbooks/all-playbooks.yaml Then listed the order in which I wanted the playbooks to be executed.\n# all-playbooks.yaml ---  - import_playbook: ping.yaml  - import_playbook: apt-update.yaml  - import_playbook: install-services.yaml  - import_playbook: app-setup.yaml  - import_playbook: lb-setup.yaml Save the playbook and run it:\nansible-playbook playbooks/all-playbooks.yaml -K Test the Loadbalancer Finally I can test the load balancer is working by browsing to the local IP\nNote that it returned it was using web1. If I connect again this time it used web2\nAnd can get some info on the balancer manager page\nThat concludes this post. In the next post in the series I will go over variables, debugging playbooks and Ansible Vault.\n","wordCount":"1109","inLanguage":"en","image":"https://markkerry.github.io/images/cover.png","datePublished":"2022-04-03T10:31:05Z","dateModified":"2022-04-03T10:31:05Z","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/2022/04/ansible-part-2/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://markkerry.github.io/about/ title=About><span>About</span></a></li><li><a href=https://markkerry.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://markkerry.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>Ansible Part 2: Playbooks</h1><div class=post-meta>April 3, 2022&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Mark kerry</div></header><figure class=entry-cover><img loading=lazy srcset="https://markkerry.github.io/posts/2022/04/ansible-part-2/images/cover_hu51bae26b1b7e2b7a0f126d16dec08f1b_76805_360x0_resize_box_3.png 360w ,https://markkerry.github.io/posts/2022/04/ansible-part-2/images/cover_hu51bae26b1b7e2b7a0f126d16dec08f1b_76805_480x0_resize_box_3.png 480w ,https://markkerry.github.io/posts/2022/04/ansible-part-2/images/cover_hu51bae26b1b7e2b7a0f126d16dec08f1b_76805_720x0_resize_box_3.png 720w ,https://markkerry.github.io/posts/2022/04/ansible-part-2/images/cover.png 734w" sizes="(min-width: 768px) 720px, 100vw" src=https://markkerry.github.io/posts/2022/04/ansible-part-2/images/cover.png alt width=734 height=346><p>Configuring an Apache Load Balancer and Web Servers with Ansible Playbooks</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#playbooks aria-label=Playbooks>Playbooks</a></li><li><a href=#create-a-playbook aria-label="Create a playbook">Create a playbook</a></li><li><a href=#setup-the-servers aria-label="Setup the servers">Setup the servers</a></li><li><a href=#configure-the-load-balancer aria-label="Configure the Load Balancer">Configure the Load Balancer</a></li><li><a href=#configure-the-web-servers aria-label="Configure the Web Servers">Configure the Web Servers</a></li><li><a href=#run-all-playbooks aria-label="Run All Playbooks">Run All Playbooks</a></li><li><a href=#test-the-loadbalancer aria-label="Test the Loadbalancer">Test the Loadbalancer</a></li></ul></div></details></div><div class=post-content><p>In this post I&rsquo;ll be going over Ansible Playbooks. The complete list of posts in this series are:</p><ol><li><a href=https://markkerry.github.io/posts/2022/04/ansible-part-1/>Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox</a></li><li>Ansible Part 2: Playbooks (This post)</li><li><a href=https://markkerry.github.io/posts/2022/04/ansible-part-3/>Ansible Part 3: Variables, Vault and Roles</a></li></ol><p>All code in these posts can be found on <a href=https://github.com/markkerry/ubuntu-config/tree/main/ansible>GitHub - ubuntu-config/ansible</a></p><h2 id=playbooks>Playbooks<a hidden class=anchor aria-hidden=true href=#playbooks>#</a></h2><p>Playbooks allow us to write ordered process and manage configurations in the form of yaml syntax. These can then be used to build out remote systems. &ldquo;Configuration as code&rdquo; means the playbook yaml files can sit in source control and be integrated with CI/CD pipelines.</p><p>You need to create a Playbook listing everything you want to apply to each instance. And since playbooks run from top to bottom, they need to be in a logically defined order.</p><p>Playbooks are made of up &ldquo;plays&rdquo; so we can include the &ldquo;tasks&rdquo; performed in part 1 as plays in the playbook.</p><p>For example the ping task: <code>ansible -m ping all</code> can be written as a play in a playbook as follows</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># ping.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ping all servers</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ping</span>
</span></span></code></pre></div><p>This can then be invoked with <code>ansible-playbook ping.yaml</code></p><h2 id=create-a-playbook>Create a playbook<a hidden class=anchor aria-hidden=true href=#create-a-playbook>#</a></h2><p>Now let&rsquo;s create some playbooks.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>mkdir ~/ansible/playbooks
</code></pre><p>Can update the apt repos with the following playbook.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim playbooks/apt-update.yaml
</code></pre><p>Then populate</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># apt-update.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>webservers:loadbalancers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>name Update apt packages</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name=* state=latest</span>
</span></span></code></pre></div><p>Notice the <code>become: true</code>. This means become root (sudo), as the <code>apt</code> commands require sudo. Without it the playbook would run as follows.</p><p><img loading=lazy src=images/missingSudo.png alt=missingSudo></p><p>So with <code>become: true</code> defined it&rsquo;s time to run the playbook as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-playbook playbooks/apt-update.yaml -K
</code></pre><p>The <code>-K</code> means &ldquo;ask for become password&rdquo;.</p><p><img loading=lazy src=images/aptUpdatePlaybook.png alt=aptUpdatePlaybook></p><h2 id=setup-the-servers>Setup the servers<a hidden class=anchor aria-hidden=true href=#setup-the-servers>#</a></h2><p>Now it&rsquo;s time to configure the Ubuntu servers; one load balancer and two web servers. All three servers will require Apache installed, however the load balancer will require the following Apache Modules which to be installed manually would be:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod lbmethod_byrequests
sudo a2enmod proxy_balancer
sudo systemctl restart apache2
</code></pre><p>But I will incorporate the Apache Modules required for a load balancer in the playbook. Also the web servers will require php in order to be able to host the custom <code>index.php</code> file I&rsquo;ll be deploying to them. Create the playbook as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim playbooks/install-services.yaml
</code></pre><p>The <code>install-services.yaml</code> looks as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># install-services.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>loadbalancers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Installing apache</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name=apache2 state=present</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure apache starts</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>service</span>: <span style=color:#ae81ff>name=apache2 state=started enabled=yes</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enable lbmethod_byrequests apache module</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>community.general.apache2_module</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>lbmethod_byrequests</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enable proxy_balancer apache module</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>community.general.apache2_module</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>proxy_balancer</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enable proxy_http apache module</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>community.general.apache2_module</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>proxy_http</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enable proxy apache module</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>community.general.apache2_module</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>webservers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Installing apache</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name=apache2 state=present</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install software-properties-common</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name=software-properties-common</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add repo php</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt_repository</span>: <span style=color:#ae81ff>repo=&#34;ppa:ondrej/php&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Updating the repo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>update_cache=yes</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Installing php</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name=php state=present</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure apache starts</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>service</span>: <span style=color:#ae81ff>name=apache2 state=started enabled=yes</span>
</span></span></code></pre></div><p>And once saved it is time to test it:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-playbook playbooks/install-services.yaml -K
</code></pre><p><img loading=lazy src=images/install-services.png alt=install-services></p><p>Now that all three servers have the required applications installed it is time to configure them.</p><h2 id=configure-the-load-balancer>Configure the Load Balancer<a hidden class=anchor aria-hidden=true href=#configure-the-load-balancer>#</a></h2><p>I&rsquo;ll start by creating a new directory to host any configuration files:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>mkdir ~/ansible/config &amp;&amp; cd ~/ansible/config
</code></pre><p>Then create a new &ldquo;jinger2&rdquo; syntax file which will will be deployed to the load balancer to configure it.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim lb-config.j2
</code></pre><p>The contents of <code>lb-config.j2</code> file are below. Notice there is some &ldquo;for loop&rdquo; logic which is going through each &ldquo;webserver&rdquo; host in the <code>hosts-dev</code> file. This means the servers do not need to be hard coded in this file and the file does not need to be updated when any web servers are added or deleted.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ProxyRequests off
</span></span><span style=display:flex><span>&lt;Proxy balancer://webcluster &gt;
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>% <span style=color:#66d9ef>for</span> hosts in groups<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;webservers&#39;</span><span style=color:#f92672>]</span> %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    BalancerMember http://<span style=color:#f92672>{{</span>hostvars<span style=color:#f92672>[</span>hosts<span style=color:#f92672>][</span><span style=color:#e6db74>&#39;ansible_host&#39;</span><span style=color:#f92672>]}}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>% endfor %<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    ProxySet lbmethod<span style=color:#f92672>=</span>byrequests
</span></span><span style=display:flex><span>&lt;/Proxy&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional</span>
</span></span><span style=display:flex><span>&lt;Location /balancer-manager&gt;
</span></span><span style=display:flex><span>  SetHandler balancer-manager
</span></span><span style=display:flex><span>&lt;/Location&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ProxyPass /balancer-manager !
</span></span><span style=display:flex><span>ProxyPass / balancer://webcluster/
</span></span></code></pre></div><p>Now that the <code>lb-config.j2</code> file has been created, we can create a playbook to deploy it the the load balancer, set the permissions and then restart Apache.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim ./playbooks/lb-setup.yaml
</code></pre><p>Here is the contents of <code>lb-setup.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>loadbalancers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Creating template</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>src</span>: <span style=color:#ae81ff>../config/lb-config.j2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/apache2/conf-enabled/lb.conf</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>064</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>restart apache</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>service</span>: <span style=color:#ae81ff>name=apache2 state=restarted</span>
</span></span></code></pre></div><p>Run the playbook:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-playbook playbooks/lb-setup.yaml -K
</code></pre><p><img loading=lazy src=images/lb-config.png alt=lb-config></p><p>That&rsquo;s all that is required to configure the load balancer.</p><h2 id=configure-the-web-servers>Configure the Web Servers<a hidden class=anchor aria-hidden=true href=#configure-the-web-servers>#</a></h2><p>To configure the web servers, I&rsquo;m simply going to deploy an <code>index.php</code> file and delete the <code>index.html</code> from the default Apache <code>/var/www/html/</code> directory.</p><p>Create the php file in the ansible directory as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim index.php
</code></pre><p>The <code>index.php</code> file will simply use a function to gather the webservers hostname, print in bold that the site has been configured by Ansible, then display the hostname. This way we can prove the load balancer is working correctly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>  $hostname <span style=color:#f92672>=</span> <span style=color:#a6e22e>gethostname</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;h1&gt;Site configured by Ansible&lt;/h1&gt;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;h2&gt;Webserver: </span><span style=color:#e6db74>$hostname</span><span style=color:#e6db74>&lt;/h2&gt;&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Now that the <code>index.php</code> file has been created, we can create a playbook to deploy it the the web servers, set the permissions, delete the old <code>index.html</code>, and then restart Apache.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim ./playbooks/app-setup.yaml
</code></pre><p>The content of the <code>app-setup.yaml</code> file is below. Notice the <code>notify</code> and <code>handlers</code> section. This means that if anything is changed in the the <code>name</code> play then to notify the handler. This particular handler will restart Apache if notified.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># app-setup.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>webservers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Copy app files</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>copy</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>src</span>: <span style=color:#ae81ff>../index.php</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/var/www/html</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0755</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>restart apache</span>
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Delete index.html</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ansible.builtin.file</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/var/www/html/index.html</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>restart apache</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>restart apache</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>service</span>: <span style=color:#ae81ff>name=apache2 state=restarted</span>
</span></span></code></pre></div><p>Run the playbook:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-playbook playbooks/app-setup.yaml -K
</code></pre><p><img loading=lazy src=images/app-setup.png alt=app-setup></p><p>And that is all that is required to configure the web servers.</p><h2 id=run-all-playbooks>Run All Playbooks<a hidden class=anchor aria-hidden=true href=#run-all-playbooks>#</a></h2><p>That&rsquo;s quite a few playbooks created in the post. We can combine them all together and deploy them in one playbook using <code>import_playbook</code>. I created a new playbook as follows:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>vim playbooks/all-playbooks.yaml
</code></pre><p>Then listed the order in which I wanted the playbooks to be executed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># all-playbooks.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>  - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>ping.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>apt-update.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>install-services.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>app-setup.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>lb-setup.yaml</span>
</span></span></code></pre></div><p>Save the playbook and run it:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>ansible-playbook playbooks/all-playbooks.yaml -K
</code></pre><p><img loading=lazy src=images/allPlaybooks.gif alt=allPlaybooks></p><h2 id=test-the-loadbalancer>Test the Loadbalancer<a hidden class=anchor aria-hidden=true href=#test-the-loadbalancer>#</a></h2><p>Finally I can test the load balancer is working by browsing to the local IP</p><p><img loading=lazy src=images/lb_web1.png alt=lb_web1></p><p>Note that it returned it was using <strong>web1</strong>. If I connect again this time it used <strong>web2</strong></p><p><img loading=lazy src=images/lb_web2.png alt=lb_web2></p><p>And can get some info on the balancer manager page</p><p><img loading=lazy src=images/balancer-manager.png alt=balancer-manager></p><p>That concludes this post. In the next post in the series I will go over variables, debugging playbooks and Ansible Vault.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://markkerry.github.io/tags/linux/>Linux</a></li><li><a href=https://markkerry.github.io/tags/ubuntu/>Ubuntu</a></li><li><a href=https://markkerry.github.io/tags/virtualbox/>VirtualBox</a></li><li><a href=https://markkerry.github.io/tags/ansible/>Ansible</a></li><li><a href=https://markkerry.github.io/tags/apache/>Apache</a></li></ul><nav class=paginav><a class=prev href=https://markkerry.github.io/posts/2022/04/ansible-part-1/><span class=title>« Prev Page</span><br><span>Ansible Part 1: Setup and Configure on Ubuntu and VirtualBox</span></a>
<a class=next href=https://markkerry.github.io/posts/2022/04/ansible-part-3/><span class=title>Next Page »</span><br><span>Ansible Part 3: Variables, Vault and Roles</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>