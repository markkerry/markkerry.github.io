<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Running a Kubernetes Cluster on Ubuntu and VirtualBox | markkerry.github.io</title><meta name=keywords content="Linux,Ubuntu,VirtualBox,Kubernetes">
<meta name=description content="In a previous post, I created the adminbox Ubuntu VM on VirtualBox.
   server ip addr comment     adminbox 10.0.2.5 Jump box from host with SSH access to all on the Nat network    In this post will be using the same setup to build a Kubernetes cluster and deploy an nginx container. I have created a further 3 VMs also connected to the KubeNatNetwork.">
<meta name=author content="Mark kerry">
<link rel=canonical href=https://markkerry.github.io/posts/2022/03/ubuntu-kubernetes-virtualbox/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://markkerry.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://markkerry.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://markkerry.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://markkerry.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://markkerry.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.93.2">
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config",'')</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XZDLE8M8RG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XZDLE8M8RG",{anonymize_ip:!1})}</script>
<meta property="og:title" content="Running a Kubernetes Cluster on Ubuntu and VirtualBox">
<meta property="og:description" content="In a previous post, I created the adminbox Ubuntu VM on VirtualBox.
   server ip addr comment     adminbox 10.0.2.5 Jump box from host with SSH access to all on the Nat network    In this post will be using the same setup to build a Kubernetes cluster and deploy an nginx container. I have created a further 3 VMs also connected to the KubeNatNetwork.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://markkerry.github.io/posts/2022/03/ubuntu-kubernetes-virtualbox/">
<meta property="og:image" content="https://markkerry.github.io/images/cover.svg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-03-06T09:39:52+00:00">
<meta property="article:modified_time" content="2022-03-06T09:39:52+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://markkerry.github.io/images/cover.svg">
<meta name=twitter:title content="Running a Kubernetes Cluster on Ubuntu and VirtualBox">
<meta name=twitter:description content="In a previous post, I created the adminbox Ubuntu VM on VirtualBox.
   server ip addr comment     adminbox 10.0.2.5 Jump box from host with SSH access to all on the Nat network    In this post will be using the same setup to build a Kubernetes cluster and deploy an nginx container. I have created a further 3 VMs also connected to the KubeNatNetwork.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://markkerry.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Running a Kubernetes Cluster on Ubuntu and VirtualBox","item":"https://markkerry.github.io/posts/2022/03/ubuntu-kubernetes-virtualbox/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Running a Kubernetes Cluster on Ubuntu and VirtualBox","name":"Running a Kubernetes Cluster on Ubuntu and VirtualBox","description":"In a previous post, I created the adminbox Ubuntu VM on VirtualBox.\n   server ip addr comment     adminbox 10.0.2.5 Jump box from host with SSH access to all on the Nat network    In this post will be using the same setup to build a Kubernetes cluster and deploy an nginx container. I have created a further 3 VMs also connected to the KubeNatNetwork.","keywords":["Linux","Ubuntu","VirtualBox","Kubernetes"],"articleBody":"In a previous post, I created the adminbox Ubuntu VM on VirtualBox.\n   server ip addr comment     adminbox 10.0.2.5 Jump box from host with SSH access to all on the Nat network    In this post will be using the same setup to build a Kubernetes cluster and deploy an nginx container. I have created a further 3 VMs also connected to the KubeNatNetwork. Note: these only have one network adapter.\n network address: 10.0.2.0/24 default gateway: 10.0.2.2     server ip addr ram vcpu comment     ctrlplane 10.0.2.10 2GB 2 Kubernetes Control Plane server   node1 10.0.2.11 2GB 2 Kubernetes worker node 1   node2 10.0.2.12 2GB 2 Kubernetes worker node 2    Each server also has an entry for each VM in the cluster, in their /etc/hosts file.\nInstall Docker (All hosts) The following commands are used to install the Docker engine\n# remove old versions sudo apt remove docker docker-engine docker.io containerd runc  # update the apt package index sudo apt update  # install prereqs to allow apt ot install packages over https sudo apt-get install \\  ca-certificates \\  curl \\  gnupg \\  lsb-release -y  # add Docker’s official GPG key curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg  # set up the stable repository echo \\  \"deb [arch=$(dpkg --print-architecture)signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs)stable\" | sudo tee /etc/apt/sources.list.d/docker.list  /dev/null  # install Docker engine sudo apt-get update sudo apt-get install docker-ce docker-ce-cli containerd.io -y  # add user to Docker group sudo usermod -a -G docker $USER  # set Docker to start automatically sudo systemctl enable docker.service sudo systemctl enable containerd.service (All hosts) Set the docker daemon cgroup driver to use systemd.\nsudo vim /etc/docker/daemon.json Add the following\n{  \"exec-opts\": [\"native.cgroupdriver=systemd\"] } Restart Docker\nsudo systemctl restart docker That completes the docker install. You can run the same commands above using a script as below:\ncurl https://raw.githubusercontent.com/markkerry/ubuntu-config/main/kubernetes/01-k8s-installDocker.sh  installDocker.sh  sudo chmod +x ./installDocker.sh \u0026\u0026 ./installDocker.sh Verify the install is complete by running\ndocker --version Restart the server\nsudo systemctl reboot And ensure Docker is running by typing\ndocker image ls Install Kubernetes (All hosts) Add the K8S key and repo\nsudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg  echo \"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list (All hosts) Update the package repository and install the K8s components:\nsudo apt update sudo apt install -y kubelet kubeadm kubectl sudo apt-mark hold kubelet kubeadm kubectl (All hosts) Disable the swap file\nsudo swapoff -a Edit /etc/fstab to remove the swap entry by commenting it out\nsudo vim /etc/fstab  # /swap.img none swap sw 0 0 Then restart the servers.\n(Control plane only) Initiate the cluster on the control plane\nsudo kubeadm init --control-plane-endpoint ctrlplane:6443 --pod-network-cidr 10.10.0.0/16 Ensure you copy the kubeadm join command from the output as will be needed to join the nodes.\nCan get the name of the host the cluster is running on by typing\nkubectl cluster-info (Control plane only) Set the kubectl context auth to connect to the cluster\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config (Control plane only) Download the yaml files for the Calico pod network addon and the sample nginx deployment\ncurl https://raw.githubusercontent.com/markkerry/ubuntu-config/main/kubernetes/calico.yaml -O curl https://raw.githubusercontent.com/markkerry/ubuntu-config/main/kubernetes/sample-deployment.yaml vim calico.yaml Uncomment the CALICO_IPV4POOL_CIDR variable in the manifest (calico.yaml) and set it to the same value as your chosen pod CIDR\n- name: CALICO_IPV4POOL_CIDR  value: \"10.10.0.0/16\" (Control plane only) Apply the deployment:\nkubectl apply -f calico.yaml  # Ensure you copy the sudo kubeadm join --token command to be used later Can put a watch on it and wait for it to complete\nwatch -n2 'kubectl get pods -A' Once complete, check the ctrlplane node is the only node and state is ready\nkubectl get nodes (Worker Nodes only) Join Nodes from the command copied earlier.\n Note: Change the $TOKEN_ID and $HASH to the appropriate values\n sudo kubeadm join --token $TOKEN_ID ctrlplane:6443 --discovery-token-ca-cert-hash sha256:$HASH (Control plane only) Once complete, check the ctrlplane has the nodes added\nkubectl get nodes Use the sample deployment file downloaded earlier\ncat sample-deployment.yaml (Control plane only) Sample Deployment file with 2 replicas running nginx:\napiVersion: apps/v1 kind: Deployment metadata:  name: nginx-deployment  labels:  app: nginx spec:  replicas: 2  selector:  matchLabels:  app: nginx  template:  metadata:  labels:  app: nginx  spec:  containers:  - name: nginx  image: nginx  ports:  - containerPort: 80 (Control plane only) Apply the deployment:\nkubectl apply -f sample-deployment.yaml  kubectl get deployments  kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-deployment-74d589986c-9mhft 1/1 Running 0 62s 10.10.166.132 node1   nginx-deployment-74d589986c-gp54z 1/1 Running 0 9m35s 10.10.104.2 node2   (Control plane only) If you want to run workloads on Control Plane it has to be untainted. Also we can up the replica count from 2 to 4\nkubectl taint nodes --all node-role.kubernetes.io/master-  # Change the replicas from 2 to 4 kubectl apply -f sample-deployment.yaml  kubctl get deployments  kubctl get pods -o wide This now show 4 replicas across the 3 vms. The ctrlplane server is now running one, node2 is running one, and node1 has two.\nNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-deployment-74d589986c-9mhft 1/1 Running 0 4m27s 10.10.166.132 node1   nginx-deployment-74d589986c-gp54z 1/1 Running 0 13m 10.10.104.2 node2   nginx-deployment-74d589986c-lwm2s 1/1 Running 0 21s 10.10.232.4 ctrlplane   nginx-deployment-74d589986c-ndspp 1/1 Running 0 21s 10.10.166.130 node1   Now we can test if nginx is running on node1 by typing:\ncurl 10.10.166.132:80 And node2:\nGenerate Token For Future Nodes (Control plane only) If you plan to add new nodes to the cluster at a later date and have lost the original token, can create a new one. Before we can use the manifest we need to be authenticated to the cluster. Generate a token to add worker Node\n#Create a new Token kubeadm token create --print-join-command #List Tokens created kubeadm token list ","wordCount":"958","inLanguage":"en","image":"https://markkerry.github.io/images/cover.svg","datePublished":"2022-03-06T09:39:52Z","dateModified":"2022-03-06T09:39:52Z","author":{"@type":"Person","name":"Mark kerry"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://markkerry.github.io/posts/2022/03/ubuntu-kubernetes-virtualbox/"},"publisher":{"@type":"Organization","name":"markkerry.github.io","logo":{"@type":"ImageObject","url":"https://markkerry.github.io/favicon.ico"}}}</script>
</head><body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header>
<nav class=nav>
<div class=logo>
<a href=https://markkerry.github.io/ accesskey=h title="markkerry.github.io (Alt + H)">markkerry.github.io</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div><ul id=menu>
<li>
<a href=https://markkerry.github.io/about/ title=About>
<span>About</span>
</a>
</li><li>
<a href=https://markkerry.github.io/archive title=Archive>
<span>Archive</span>
</a>
</li><li>
<a href=https://markkerry.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://markkerry.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://markkerry.github.io/posts/>Posts</a></div><h1 class=post-title>
Running a Kubernetes Cluster on Ubuntu and VirtualBox
</h1><div class=post-meta>March 6, 2022&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Mark kerry
</div></header><figure class=entry-cover>
<img loading=lazy src=https://markkerry.github.io/posts/2022/03/ubuntu-kubernetes-virtualbox/images/cover.svg alt>
<p>Build a Kubernetes cluster from scratch on Ubuntu and VirtualBox</p></figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>Table of Contents</div></summary>
<div class=inner><ul>
<li>
<a href=#install-docker aria-label="Install Docker">Install Docker</a></li><li>
<a href=#install-kubernetes aria-label="Install Kubernetes">Install Kubernetes</a></li><li>
<a href=#generate-token-for-future-nodes aria-label="Generate Token For Future Nodes">Generate Token For Future Nodes</a>
</li></ul></div></details>
</div><div class=post-content><p>In a <a href=https://markkerry.github.io/posts/2022/02/ubuntu-server-lab/>previous post</a>, I created the adminbox Ubuntu VM on VirtualBox.</p><table>
<thead>
<tr>
<th>server</th><th>ip addr</th><th>comment</th></tr></thead><tbody>
<tr>
<td>adminbox</td><td>10.0.2.5</td><td>Jump box from host with SSH access to all on the Nat network</td></tr></tbody></table><p>In this post will be using the same setup to build a Kubernetes cluster and deploy an nginx container. I have created a further 3 VMs also connected to the KubeNatNetwork. Note: these only have one network adapter.</p><ul>
<li>network address: 10.0.2.0/24</li><li>default gateway: 10.0.2.2</li></ul><table>
<thead>
<tr>
<th>server</th><th>ip addr</th><th>ram</th><th>vcpu</th><th>comment</th></tr></thead><tbody>
<tr>
<td>ctrlplane</td><td>10.0.2.10</td><td>2GB</td><td>2</td><td>Kubernetes Control Plane server</td></tr><tr>
<td>node1</td><td>10.0.2.11</td><td>2GB</td><td>2</td><td>Kubernetes worker node 1</td></tr><tr>
<td>node2</td><td>10.0.2.12</td><td>2GB</td><td>2</td><td>Kubernetes worker node 2</td></tr></tbody></table><p><img loading=lazy src=images/vms.png alt=vms>
</p><p>Each server also has an entry for each VM in the cluster, in their <code>/etc/hosts</code> file.</p><h2 id=install-docker>Install Docker<a hidden class=anchor aria-hidden=true href=#install-docker>#</a></h2><p>(All hosts) The following commands are used to install the Docker engine</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># remove old versions</span>
</span></span><span style=display:flex><span>sudo apt remove docker docker-engine docker.io containerd runc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># update the apt package index</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># install prereqs to allow apt ot install packages over https</span>
</span></span><span style=display:flex><span>sudo apt-get install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ca-certificates <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gnupg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    lsb-release -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add Docker’s official GPG key</span>
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># set up the stable repository</span>
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;deb [arch=</span><span style=color:#66d9ef>$(</span>dpkg --print-architecture<span style=color:#66d9ef>)</span><span style=color:#e6db74> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># install Docker engine</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install docker-ce docker-ce-cli containerd.io -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add user to Docker group</span>
</span></span><span style=display:flex><span>sudo usermod -a -G docker $USER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># set Docker to start automatically</span>
</span></span><span style=display:flex><span>sudo systemctl enable docker.service
</span></span><span style=display:flex><span>sudo systemctl enable containerd.service
</span></span></code></pre></div><p>(All hosts) Set the docker daemon cgroup driver to use systemd.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/docker/daemon.json
</span></span></code></pre></div><p>Add the following</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;exec-opts&#34;</span>: [<span style=color:#e6db74>&#34;native.cgroupdriver=systemd&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Restart Docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div><p>That completes the docker install. You can run the same commands above using a script as below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://raw.githubusercontent.com/markkerry/ubuntu-config/main/kubernetes/01-k8s-installDocker.sh &gt; installDocker.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x ./installDocker.sh <span style=color:#f92672>&amp;&amp;</span> ./installDocker.sh
</span></span></code></pre></div><p>Verify the install is complete by running</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker --version
</span></span></code></pre></div><p>Restart the server</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl reboot
</span></span></code></pre></div><p>And ensure Docker is running by typing</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker image ls
</span></span></code></pre></div><h2 id=install-kubernetes>Install Kubernetes<a hidden class=anchor aria-hidden=true href=#install-kubernetes>#</a></h2><p>(All hosts) Add the K8S key and repo</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></code></pre></div><p>(All hosts) Update the package repository and install the K8s components:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y kubelet kubeadm kubectl
</span></span><span style=display:flex><span>sudo apt-mark hold kubelet kubeadm kubectl
</span></span></code></pre></div><p>(All hosts) Disable the swap file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo swapoff -a
</span></span></code></pre></div><p>Edit <code>/etc/fstab</code> to remove the swap entry by commenting it out</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/fstab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /swap.img   none  swap  sw  0   0</span>
</span></span></code></pre></div><p>Then restart the servers.</p><p>(Control plane only) Initiate the cluster on the control plane</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubeadm init --control-plane-endpoint ctrlplane:6443 --pod-network-cidr 10.10.0.0/16
</span></span></code></pre></div><p><img loading=lazy src=images/kubeadm-init.png alt=kubeadm-init>
</p><p>Ensure you copy the <code>kubeadm join</code> command from the output as will be needed to join the nodes.</p><p><img loading=lazy src=images/kubeadm-init2.png alt=kubeadm-init2>
</p><p>Can get the name of the host the cluster is running on by typing</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p><img loading=lazy src=images/cluster-info.png alt=cluster-info>
</p><p>(Control plane only) Set the <code>kubectl</code> context auth to connect to the cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span></code></pre></div><p>(Control plane only) Download the yaml files for the Calico pod network addon and the sample nginx deployment</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://raw.githubusercontent.com/markkerry/ubuntu-config/main/kubernetes/calico.yaml -O
</span></span><span style=display:flex><span>curl https://raw.githubusercontent.com/markkerry/ubuntu-config/main/kubernetes/sample-deployment.yaml
</span></span><span style=display:flex><span>vim calico.yaml
</span></span></code></pre></div><p>Uncomment the <code>CALICO_IPV4POOL_CIDR</code> variable in the manifest (calico.yaml) and set it to the same value as your chosen pod CIDR</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>CALICO_IPV4POOL_CIDR</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;10.10.0.0/16&#34;</span>
</span></span></code></pre></div><p>(Control plane only) Apply the deployment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f calico.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ensure you copy the sudo kubeadm join --token command to be used later</span>
</span></span></code></pre></div><p>Can put a watch on it and wait for it to complete</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>watch -n2 <span style=color:#e6db74>&#39;kubectl get pods -A&#39;</span>
</span></span></code></pre></div><p><img loading=lazy src=images/get-pods.png alt=get-pods>
</p><p>Once complete, check the ctrlplane node is the only node and state is ready</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img loading=lazy src=images/get-nodes.png alt=get-nodes>
</p><p>(Worker Nodes only) Join Nodes from the command copied earlier.</p><blockquote>
<p><em>Note: Change the $TOKEN_ID and $HASH to the appropriate values</em></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubeadm join --token $TOKEN_ID ctrlplane:6443 --discovery-token-ca-cert-hash sha256:$HASH
</span></span></code></pre></div><p><img loading=lazy src=images/kubeadm-join.png alt=kubeadm-join>
</p><p>(Control plane only) Once complete, check the ctrlplane has the nodes added</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img loading=lazy src=images/get-nodes2.png alt=get-nodes2>
</p><p>Use the sample deployment file downloaded earlier</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat sample-deployment.yaml
</span></span></code></pre></div><p>(Control plane only) Sample Deployment file with 2 replicas running nginx:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
</span></span></code></pre></div><p>(Control plane only) Apply the deployment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f sample-deployment.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get deployments
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get pods -o wide
</span></span></code></pre></div><pre tabindex=0><code class=language-termial data-lang=termial>NAME                                READY   STATUS    RESTARTS   AGE     IP              NODE    NOMINATED NODE   READINESS GATES
nginx-deployment-74d589986c-9mhft   1/1     Running   0          62s     10.10.166.132   node1   &lt;none&gt;           &lt;none&gt;
nginx-deployment-74d589986c-gp54z   1/1     Running   0          9m35s   10.10.104.2     node2   &lt;none&gt;           &lt;none&gt;
</code></pre><p>(Control plane only) If you want to run workloads on Control Plane it has to be untainted. Also we can up the replica count from 2 to 4</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Change the replicas from 2 to 4</span>
</span></span><span style=display:flex><span>kubectl apply -f sample-deployment.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubctl get deployments
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubctl get pods -o wide
</span></span></code></pre></div><p>This now show 4 replicas across the 3 vms. The ctrlplane server is now running one, node2 is running one, and node1 has two.</p><pre tabindex=0><code class=language-terminal data-lang=terminal>NAME                                READY   STATUS    RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES
nginx-deployment-74d589986c-9mhft   1/1     Running   0          4m27s   10.10.166.132   node1       &lt;none&gt;           &lt;none&gt;
nginx-deployment-74d589986c-gp54z   1/1     Running   0          13m     10.10.104.2     node2       &lt;none&gt;           &lt;none&gt;
nginx-deployment-74d589986c-lwm2s   1/1     Running   0          21s     10.10.232.4     ctrlplane   &lt;none&gt;           &lt;none&gt;
nginx-deployment-74d589986c-ndspp   1/1     Running   0          21s     10.10.166.130   node1       &lt;none&gt;           &lt;none&gt;
</code></pre><p>Now we can test if nginx is running on node1 by typing:</p><pre tabindex=0><code class=language-terminal data-lang=terminal>curl 10.10.166.132:80
</code></pre><p><img loading=lazy src=images/curlNode1.png alt=curlNode1>
</p><p>And node2:</p><p><img loading=lazy src=images/curlNode2.png alt=curlNode2>
</p><h2 id=generate-token-for-future-nodes>Generate Token For Future Nodes<a hidden class=anchor aria-hidden=true href=#generate-token-for-future-nodes>#</a></h2><p>(Control plane only) If you plan to add new nodes to the cluster at a later date and have lost the original token, can create a new one. Before we can use the manifest we need to be authenticated to the cluster. Generate a token to add worker Node</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Create a new Token</span>
</span></span><span style=display:flex><span>kubeadm token create --print-join-command
</span></span><span style=display:flex><span><span style=color:#75715e>#List Tokens created</span>
</span></span><span style=display:flex><span>kubeadm token list
</span></span></code></pre></div></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://markkerry.github.io/tags/linux/>Linux</a></li><li><a href=https://markkerry.github.io/tags/ubuntu/>Ubuntu</a></li><li><a href=https://markkerry.github.io/tags/virtualbox/>VirtualBox</a></li><li><a href=https://markkerry.github.io/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav>
<a class=next href=https://markkerry.github.io/posts/2022/02/acr-push-pull/>
<span class=title>Next Page »</span>
<br>
<span>Quick How-to: Push/Pull to Azure Container Registry</span>
</a>
</nav></footer></article></main><footer class=footer>
<span>&copy; 2022 <a href=https://markkerry.github.io/>markkerry.github.io</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script>
</body></html>